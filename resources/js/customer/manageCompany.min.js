

const API = {
    getCompanyListForCustomer: 'customer/companies',
    approveCompany : 'customer/companies'
};

class ManageCompany{
    constructor() {
        let companyList = null;
        let dataTable = null;

        let updateDataTable = () => {
            let Datatable = [];
            dataTable.fnClearTable();
            companyList.map((item,index) => {
                let ret = [];
                ret[0] = item.company_name;
                ret[1] = item.is_approved ? 
                `   <center>
                        <h4><span class="badge badge-pill badge-success">Approved</span></h4>
                    </center>
                ` 
                : ` <center>
                        <h4><span class="badge badge-pill badge-warning">Pending for approval</span></h4>
                    </center>
                  `;
                ret[2] = item.is_approved ? 
                        ''
                         :
                         `<center>
                            <button class="btn btn-success btn-sm btn-radius btn-approve" index="${index}"><i class="fas fa-check-circle"></i> Approve</button>
                          </center>`;
                Datatable.push(ret);
            });
            dataTable.fnAddData(Datatable);

            $(".btn-approve").unbind().click(function(){
                let index = $(this).attr('index');
                swal({
                    title: "Are you sure?",
                    text: `to approve company name : ${companyList[index].company_name}`,
                    icon: "warning",
                    buttons: true,
                    dangerMode: true,
                }).then((willDelete) => {
                    if (willDelete) {
                        approveCompany(index);
                    } else {
                        return;
                    }
                });
            });
        }

        let approveCompany = (index) => {
            $.ajax({
                url:END_POINT+API.approveCompany,
                method:'PUT',
                data:{
                    company_id : companyList[index].company_id,
                },
                success:(res) => {
                    showLastDataTable();
                },
                error:(res) => {
                    console.log(res);
                }
            })
        }

        let initialDatatable = () => {
            if (dataTable !== null) {
                return false;
            }

            dataTable = $('#company_list').dataTable({});
        };

        let showDatatableLoadingStatus = (showOrHide) => {
            if (showOrHide) {
                $(".dataTables_wrapper").hide();
                $('#company_list').hide();
                $('.lds-roller').show();
            } else {
                $(".dataTables_wrapper").show();
                $('.lds-roller').hide();
                $('.text-loading').hide();
                $('#company_list').show();
                $('.text-static').show();
            }
        };

        let showLastDataTable = () => {
            showDatatableLoadingStatus(true);
            $.ajax({
                url:END_POINT+API.getCompanyListForCustomer,
                method:"GET",
                success:(res) => {
                    initialDatatable();
                    companyList = res.data;
                    updateDataTable();
                    showDatatableLoadingStatus(false);
                },
                error:(res) => {
                    console.log(res);
                }
            });
        };

        this.initAndRun = () => {
            showLastDataTable();
        };
    }
}



$(document).ready(function(){
    let manageCompany = new ManageCompany();
    manageCompany.initAndRun();
});
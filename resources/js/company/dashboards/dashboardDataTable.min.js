import {
    LOADING,
    checkAuthRes,
    checkError,
    addEventValidate,
    resetInputValidate
} from '../../utility';


const API = {
    getStaticDashboard: "dashboards",
    getUsernameInCompany: "users/username/company",
    getStaticDashboardCustomer: "dashboards/company/customers",
    addStaticDashboard: "dashboards",
    editStaticDashboard: "dashboards",
    deleteStaticDashboard: "dashboards",
}

validate.validators.presence.message = "is required";

let validateInput = {
    create: {
        parent: "form#create_static",
        validate: {
            name: {
                presence: {
                    allowEmpty: false,
                },
                length: {
                    maximum: 20
                }
            },
            description: {
                length: {
                    maximum: 200
                }
            }
        }
    },
    createForCustomer: {
        parent: "form#create_static",
        validate: {
            name: {
                presence: {
                    allowEmpty: false,
                },
                length: {
                    maximum: 20
                }
            },
            description: {
                length: {
                    maximum: 200
                }
            },
            customer: {
                presence: {
                    allowEmpty: false,
                },
            }
        }
    },
    edit: {
        parent: "form#form_edit_static",
        validate: {
            name: {
                presence: {
                    allowEmpty: false,
                },
                length: {
                    maximum: 20
                }
            },
            description: {
                length: {
                    maximum: 200
                }
            }
        }
    }
}

let state = {
    tab_selected: "company-tab",
}

class staticDataTable {
    constructor() {
        let staticDataTableCompany = null;
        let staticDataTableCustomer = null;
        let staticListCompany = null;
        let staticListCustomer = null;
        let modalEdit = null;
        let modalDelete = null;
        let usernameList = null;

        let self = this;

        let customerList = $("#customerList");


        let bindElement = () => {
            $("#btn-add-static").click(function () {
                resetInputValidate();
                $("#addStatic").modal('show');
            });

            $("#btn-save-add-static").click(function () {
                addStaticDashboard();
            });

            $(".card-body .nav-link").click(function () {
                state.tab_selected = $(this).attr("id");
                if (state.tab_selected === "company-tab") {
                    customerList.hide();
                    self.showLastestDatatableCompany();
                } else if (state.tab_selected === "customer-tab") {
                    customerList.show();
                    self.showLastestDatatableCustomer();
                }
            });

            addEventValidate(validateInput.create);
        };

        // let getStaticDashboardCustomer = () => {
        //     showDatatableLoadingStatus(true);
        //     $.ajax({
        //         url: END_POINT + API.getStaticDashboardCustomer,
        //         method: 'GET',
        //         headers: {
        //             authorization: 'bearer ' + getCookie('token'),
        //         },
        //         success: (res, textStatus, xhr) => {
        //             checkAuthRes(xhr);
        //             staticDataTableCustomer = res.data;
        //             updateDatatableData();
        //             showDatatableLoadingStatus(false);
        //         },
        //         error: (res) => {
        //             console.log(res);
        //         }
        //     });
        // }

        let addStaticDashboard = () => {
            let param = {};
            let static_name = $("#static-name").val();
            let desc = $("#desc").val();
            let customer = $("select[name='customer']").val()
            if (state.tab_selected === "company-tab") {
                if (checkError(validateInput.create)) {
                    return;
                }
                param['name'] = static_name;
                param['desc'] = desc;
            } else {
                if (checkError(validateInput.createForCustomer)) {
                    return;
                }
                param['name'] = static_name;
                param['desc'] = desc;
                param['customer_id'] = customer;
            }
            LOADING.set($("#btn-save-add-static"));

            $.ajax({
                url: END_POINT + API.addStaticDashboard,
                method: 'POST',
                headers: {
                    authorization: 'bearer ' + getCookie('token'),
                },
                data: param,
                success: (res, textStatus, xhr) => {
                    checkAuthRes(xhr);
                    console.log(res);
                    $("#addStatic").modal('hide');
                    LOADING.reset($("#btn-save-add-static"));
                    if (state.tab_selected == "company-tab") {
                        this.showLastestDatatableCompany();
                    } else {
                        this.showLastestDatatableCustomer();
                    }
                },
                error: (res) => {
                    console.log(res);
                    LOADING.reset($("#btn-save-add-static"));
                }
            });
        };

        let updateDatatableData = () => {
            let Datatable = [];
            staticDataTableCompany.fnClearTable();
            $.each(staticListCompany, function (index, item) {
                let ret = [];
                ret[0] = item.name;
                ret[1] = item.fname + ' ' + item.lname;
                ret[2] = item.description;
                ret[3] = `<center>
                            <button type="button" class="btn btn-primary btn-sm btn-lookup" key=${item.dashboard_id} data-toggle="tooltip"
                                data-placement="top" title="Look">
                                <i class="fas fa-search"></i>
                            </button>
                            <button type="button" class="btn btn-success btn-sm btn-edit" index=${index}  data-toggle="tooltip"
                                data-placement="top" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-danger btn-sm btn-delete" index=${index}  data-toggle="tooltip"
                                data-placement="top" title="Delete">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                          </center>`;
                Datatable.push(ret);
            });

            if (Datatable.length > 0)
                staticDataTableCompany.fnAddData(Datatable);

            $("#companyTable").on('click', ".btn-lookup", function () {
                onBtnLookupClick($(this).attr('key'));
            });

            $("#companyTable").on('click', ".btn-edit", function () {
                onBtnEditClick($(this).attr('index'));
            });

            $("#companyTable").on('click', ".btn-delete", function () {
                onBtnDeleteClick($(this).attr('index'));
            });

            $('[data-toggle="tooltip"]').tooltip();
        };

        let updateDatatableDataCustomer = () => {
            let Datatable = [];
            staticDataTableCustomer.fnClearTable();
            $.each(staticListCustomer, function (index, item) {
                let ret = [];
                ret[0] = item.name;
                ret[1] = item.fname + ' ' + item.lname;
                ret[2] = item.description;
                ret[3] = `<center>
                            <button type="button" class="btn btn-primary btn-sm btn-lookup" key=${item.dashboard_id} index=${index} data-toggle="tooltip"
                                data-placement="top" title="Look">
                                <i class="fas fa-search"></i>
                            </button>
                            <button type="button" class="btn btn-success btn-sm btn-edit" index=${index}  data-toggle="tooltip"
                                data-placement="top" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                         
                          </center>`;
                Datatable.push(ret);

            //     <button type="button" class="btn btn-danger btn-sm btn-delete" index=${index}  data-toggle="tooltip"
            //     data-placement="top" title="Delete">
            //     <i class="fas fa-trash-alt"></i>
            // </button>
            });

            if (Datatable.length > 0)
                staticDataTableCustomer.fnAddData(Datatable);

            $("#customerTable").on('click', ".btn-lookup", function () {
                onBtnLookupClick($(this).attr('key'), $(this).attr('index'));
            });

            $("#customerTable").on('click', ".btn-edit", function () {
                onBtnEditClick($(this).attr('index'));
            });

            // $("#customerTable").on('click', ".btn-delete", function () {
            //     onBtnDeleteClick($(this).attr('index'));
            // });

            $('[data-toggle="tooltip"]').tooltip();
        }

        let onBtnLookupClick = (key, index) => {
            if (state.tab_selected === "company-tab") {
                window.location.href = END_POINT_WED + "/Dashboards/" + key + "/Company/Me";
            } else {
                window.location.href = END_POINT_WED + "/Dashboards/" + key + "/Customer/" + staticListCustomer[index].user_id;
            }
        };

        let onBtnEditClick = (key) => {
            resetInputValidate();
            if (modalEdit === null) {
                modalEdit = `
                <div class="modal fade" id="editStatic">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Edit Static</h4>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>

                            <div class="modal-body">
                                <form id="form_edit_static">
                                    <div class="row">
                                        <div class="col-12">
                                            <label>Name <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" name="name" id="edit_static_name">
                                            <small class="messages-error"></small>
                                        </div>
                                        <div class="col-12">
                                            <label>Description</label>
                                            <textarea id="edit_desc" name="description"  cols="30" rows="10" class="form-control"></textarea>
                                            <small class="messages-error"></small>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <div class="modal-footer">
                                <button type="button" id="btn-edit-submit" class="btn btn-success btn-block" data-loading-text="<i class='fas fa-circle-notch fa-spin'></i> Saving . . .">Save</button>
                            </div>
                        </div>
                    </div>
                </div>`;

                $('body').append(modalEdit);

                addEventValidate(validateInput.edit);
            }

            $("#btn-edit-submit").unbind().click(function () {
                onBtnSubmitEditClick(key);
            });


            if (state.tab_selected == "company-tab") {
                $("#edit_static_name").val(staticListCompany[key].name);
                $("#edit_desc").val(staticListCompany[key].description);
            } else {
                $("#edit_static_name").val(staticListCustomer[key].name);
                $("#edit_desc").val(staticListCustomer[key].description);
            }
            $("#editStatic").modal('show');
        };

        let onBtnSubmitEditClick = (key) => {
            if (checkError(validateInput.edit)) {
                return;
            }
            LOADING.set($("#btn-edit-submit"));
            $.ajax({
                url: END_POINT + API.editStaticDashboard,
                method: 'PUT',
                headers: {
                    authorization: 'bearer ' + getCookie('token'),
                },
                data: {
                    dashboard_id: state.tab_selected == "company-tab" ? staticListCompany[key].dashboard_id : staticListCustomer[key].dashboard_id,
                    name: $("#edit_static_name").val(),
                    desc: $("#edit_desc").val(),
                },
                success: (res, textStatus, xhr) => {
                    checkAuthRes(xhr)
                    $("#editStatic").modal('hide');
                    LOADING.reset($("#btn-edit-submit"));
                    if (state.tab_selected == "company-tab") {
                        this.showLastestDatatableCompany();
                    } else {
                        this.showLastestDatatableCustomer();
                    }
                },
                error: (res) => {
                    LOADING.reset($("#btn-edit-submit"));
                    console.log(res);
                }
            });
        };

        let onBtnDeleteClick = (key) => {
            if (modalDelete === null) {
                modalDelete = `
                <div class="modal fade" id="deleteStatic">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Delete Static</h4>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>

                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-12">
                                        Are you sure to delete static name : <span id="delete-static-name"></span> ?
                                    </div>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="button" id="btn-submit-delete" class="btn btn-danger btn-block" data-loading-text="<i class='fas fa-circle-notch fa-spin'></i> Saving . . .">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>`;

                $('body').append(modalDelete);
            }

            $("#btn-submit-delete").unbind().click(function () {
                onBtnSubmitDeleteClick(key);
            });

            if (state.tab_selected == "company-tab") {
                $("#delete-static-name").html(staticListCompany[key].name);
            } else {
                $("#delete-static-name").html(staticListCustomer[key].name);
            }

            $("#deleteStatic").modal('show');
        };

        let onBtnSubmitDeleteClick = (key) => {
            LOADING.set($("#btn-submit-delete"));
            $.ajax({
                url: END_POINT + API.deleteStaticDashboard,
                method: "DELETE",
                headers: {
                    authorization: 'bearer ' + getCookie('token'),
                },
                data: {
                    dashboard_id: state.tab_selected == "company-tab" ? staticListCompany[key].dashboard_id : staticListCustomer[key].dashboard_id,
                },
                success: (res, textStatus, xhr) => {
                    checkAuthRes(xhr)
                    LOADING.reset($("#btn-submit-delete"));
                    $("#deleteStatic").modal('hide');
                    if (state.tab_selected == "company-tab") {
                        this.showLastestDatatableCompany();
                    } else {
                        this.showLastestDatatableCustomer();
                    }
                },
                error: (res) => {
                    LOADING.reset($("#btn-submit-delete"));
                    console.log(res);
                }

            });
        };

        let initialDatatable = () => {
            if (staticDataTableCompany !== null && staticDataTableCustomer !== null) {
                return false;
            }
            staticDataTableCompany = $('#companyTable').dataTable({});
            staticDataTableCustomer = $('#customerTable').dataTable({});

        };

        let showDatatableLoadingStatus = (showOrHide) => {
            if (showOrHide) {
                $(".dataTables_wrapper").hide();
                if (state.tab_selected === "company-tab") {
                    $('#companyTable').hide();
                } else {
                    $('#customerTable').hide();
                }
                $('.lds-roller').show();
            } else {
                $(".dataTables_wrapper").show();
                $('.lds-roller').hide();
                $('.text-loading').hide();
                if (state.tab_selected === "company-tab") {
                    $('#companyTable').show();
                } else {
                    $('#customerTable').show();
                }
                $('.text-static').show();
            }
        };

        let createUserList = () => {
            let elCustomer = $("select[name='customer']");
            let html = '<option value="">--Select customer--</option>';
            usernameList.map(_user => {
                html += `<option value="${_user.user_id}">${_user.username}</option>`
            });
            elCustomer.html(html);
        }

        let getUsernameInCompany = () => {
            $.ajax({
                url: END_POINT + API.getUsernameInCompany,
                method: "GET",
                success: (res, textStatus, xhr) => {
                    checkAuthRes(xhr);
                    usernameList = res.data;
                    createUserList();
                },
                error: (res) => {
                    console.log(res)
                }
            })
        };

        this.initialAndRun = () => {
            bindElement();
            initialDatatable();
            this.showLastestDatatableCompany();
            getUsernameInCompany();
        };

        this.showLastestDatatableCustomer = () => {
            showDatatableLoadingStatus(true);
            $.ajax({
                url: END_POINT + API.getStaticDashboardCustomer,
                headers: {
                    authorization: 'bearer ' + getCookie('token'),
                },
                success: (res, textStatus, xhr) => {
                    checkAuthRes(xhr)
                    showDatatableLoadingStatus(false);
                    staticListCustomer = res.data;
                    updateDatatableDataCustomer();
                },
                error: (res) => {
                    showDatatableLoadingStatus(false);
                }
            });
        };

        this.showLastestDatatableCompany = () => {
            showDatatableLoadingStatus(true);
            $.ajax({
                url: END_POINT + API.getStaticDashboard,
                headers: {
                    authorization: 'bearer ' + getCookie('token'),
                },
                success: (res, textStatus, xhr) => {
                    checkAuthRes(xhr)
                    showDatatableLoadingStatus(false);
                    staticListCompany = res.data;
                    updateDatatableData();
                },
                error: (res) => {
                    showDatatableLoadingStatus(false);
                }
            });
        };
    }
}

$(document).ready(function () {
    let et = new staticDataTable();
    et.initialAndRun();
});

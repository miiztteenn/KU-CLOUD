const END_POINT = 'http://localhost:8000/api/';

const API = {
    getAccount: 'account',
    uploadProfile: 'account/profile',
    changePrimaryEmail: 'account/email',
    addEmail: 'account/email',
    deleteEmail: 'account/email',
    changePrimaryPhone: 'account/phone',
    addPhone: 'account/phone',
    deletephone: 'account/phone',
};

class Account {
    constructor() {
        let accountData = null;

        let createEmailAndPhone = () => {
            let email_select = "";
            let email_list = accountData.email.map((data, index) => {
                status = "";
                if (data.is_primary) {
                    status += `<span class="badge badge-pill badge-primary d-flex justify-content-center align-items-center">Primary</span>`;
                }
                if (data.is_verify && !data.is_primary) {
                    email_select += `<option value=${data.email_user}>${data.email_user}</option>`;
                    status += `<span class="badge badge-pill badge-success d-flex justify-content-center align-items-center">Verify success</span> 
                               <i class="far fa-trash-alt text-danger ml-3 btn-delete-email"  style="cursor:pointer" email="${data.email_user}" index="${index}"></i>`;
                } else if (data.is_verify && data.is_primary) {
                    status += `<span class="badge badge-pill badge-success d-flex justify-content-center align-items-center">Verify success</span> `;
                } else {
                    status += `<span class="badge badge-pill badge-danger d-flex justify-content-center align-items-center">Verify not success</span> 
                               <i class="fas fa-paper-plane text-primary  ml-3" style="cursor:pointer" email="${data.email_user}"></i> 
                               <i class="far fa-trash-alt text-danger ml-3 btn-delete-email"  style="cursor:pointer" email="${data.email_user}" index="${index}"></i> `;
                }
                return `<li class="list-group-item mt-1" id="email-${index}" style="padding:.375rem .75rem;">
                            <div class="row">
                                <div class="col-6">
                                ${data.email_user} 
                                </div>
                                <div class="col-6 d-flex justify-content-end">
                                ${status}
                                </div>
                            </div>
                        </li>`;
            });

            let phone_select = "";
            let phone_list = accountData.phone.map((data, index) => {
                status = "";
                if (data.is_primary) {
                    status = `<span class="badge badge-pill badge-primary d-flex justify-content-center align-items-center">Primary</span>`;
                }
                if (data.is_verify && !data.is_primary) {
                    phone_select += `<option value=${data.phone_user}>${data.phone_user}</option>`;
                    status += `<span class="badge badge-pill badge-success d-flex justify-content-center align-items-center">Verify success</span> 
                               <i class="far fa-trash-alt text-danger ml-3 btn-delete-phone"  style="cursor:pointer" phone="${data.phone_user}" index="${index}"></i>`;
                } else if (data.is_verify && data.is_primary) {
                    status += `<span class="badge badge-pill badge-success d-flex justify-content-center align-items-center">Verify success</span> `;
                } else {
                    status += `<span class="badge badge-pill badge-danger d-flex justify-content-center align-items-center">Verify not success</span>
                               <i class="fas fa-paper-plane text-primary  ml-3" style="cursor:pointer" phone="${data.phone_user}"></i> 
                               <i class="far fa-trash-alt text-danger ml-3 btn-delete-phone"  style="cursor:pointer" phone="${data.phone_user}" index="${index}"></i> `;
                }
                return `<li class="list-group-item mt-1" id="phone-${index}"  style="padding:.375rem .75rem;">
                            <div class="row">
                                <div class="col-6">
                                ${data.phone_user} 
                                </div>
                                <div class="col-6 d-flex justify-content-end">
                                ${status}
                                </div>
                            </div>
                        </li>`;
            });

            $("#select-email").html(email_select);
            $("#select-phone").html(phone_select);

            $('#list-email').html(email_list.join(''));
            $('#list-phone').html(phone_list.join(''));

            $(".btn-delete-email").unbind().click(function () {
                let email = $(this).attr('email');
                swal({
                    title: "Are you sure",
                    text: `to delete this email address ${email} ?`,
                    icon: "warning",
                    buttons: true,
                    dangerMode: true,
                }).then((willDelete) => {
                    if (willDelete) {
                        deleteEmail($(this));
                    } else {
                        return;
                    }
                });
            });

            $(".btn-delete-phone").unbind().click(function () {
                let phone = $(this).attr('phone');
                swal({
                    title: "Are you sure",
                    text: `to delete this phone number ${phone} ?`,
                    icon: "warning",
                    buttons: true,
                    dangerMode: true,
                }).then((willDelete) => {
                    if (willDelete) {
                        deletePhone($(this));
                    } else {
                        return;
                    }
                });
            });
        };

        let deleteEmail = (el) => {
            let email = $(el).attr('email');
            let index = $(el).attr('index');
            $.ajax({
                url: END_POINT + API.deleteEmail,
                method: 'DELETE',
                data: {
                    email: email
                },
                success: (res) => {
                    $(`#email-${index}`).remove();
                },
                error: (res) => {
                    console.log(res);
                }
            });
        };

        let deletePhone = (el) => {
            let phone = $(el).attr('phone');
            let index = $(el).attr('index');
            $.ajax({
                url: END_POINT + API.deletephone,
                method: 'DELETE',
                data: {
                    phone: phone
                },
                success: (res) => {
                    $(`#phone-${index}`).remove();
                },
                error: (res) => {
                    console.log(res);
                }
            });
        };

        let bindElement = () => {

            $("input[name='img-profile']").change(function () {
                $("#imageUploadForm").submit();
            })

            $('#imageUploadForm').on('submit', (function (e) {
                e.preventDefault();
                console.log(this);
                let formData = new FormData(this);

                $.ajax({
                    type: 'POST',
                    url: END_POINT + API.uploadProfile,
                    data: formData,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        location.reload();
                        // console.log("success");
                        // console.log(data);
                    },
                    error: function (data) {
                        console.log("error");
                        console.log(data);
                    }
                });
            }));

            $("#btn-add-email").unbind().click(function () {
                addEmail();
            });

            $("#btn-save-email-pri").unbind().click(function () {
                changePrimaryEmail();
            });

            $("#btn-add-phone").unbind().click(function () {
                addPhone();
            });

            $("#btn-save-phone-pri").unbind().click(function () {
                changePrimaryPhone();
            });
        };

        let addEmail = () => {
            let email = $("input[name='add-email']").val();
            $.ajax({
                url: END_POINT + API.addEmail,
                method: 'POST',
                data: {
                    email: email
                },
                success: (res) => {
                    $("input[name='add-email']").val('');
                    this.showDataLast();
                },
                error: (res) => {

                }
            });
        };

        let changePrimaryEmail = () => {
            let email = $("#select-email").val();
            $.ajax({
                url: END_POINT + API.changePrimaryEmail,
                method: 'PUT',
                data: {
                    email: email
                },
                success: (res) => {
                    this.showDataLast();
                },
                error: (res) => {
                    console.log(res);
                }
            });
        };

        let addPhone = () => {
            let phone = $("input[name='add-phone']").val();
            $.ajax({
                url: END_POINT + API.addPhone,
                method: 'POST',
                data: {
                    phone: phone
                },
                success: (res) => {
                    $("input[name='add-phone']").val('');
                    this.showDataLast();
                },
                error: (res) => {

                }
            });
        };

        let changePrimaryPhone = () => {
            let phone = $("#select-phone").val();
            $.ajax({
                url: END_POINT + API.changePrimaryPhone,
                method: 'PUT',
                data: {
                    phone: phone
                },
                success: (res) => {
                    this.showDataLast();
                },
                error: (res) => {
                    console.log(res);
                }
            });
        };

        this.initialAndRun = () => {
            this.showDataLast();
            bindElement();
        };

        this.showDataLast = () => {
            $.ajax({
                url: END_POINT + API.getAccount,
                success: (res) => {
                    accountData = res.data;
                    createEmailAndPhone();
                },
                error: (res) => {
                    console.log(res);
                }
            });
        };
    }
}


$(document).ready(function () {
    let account = new Account();
    account.initialAndRun();
});

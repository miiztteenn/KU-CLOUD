import { LOADING,getFlatObject } from '../../utility';
import { Object } from 'core-js';

const END_POINT = 'http://localhost:8000/api/';
const END_POINT_WED = 'http://localhost:8000/';

const API = {
    getAll : 'company/analysis/data',
    create : 'company/analysis/data'
}

class DataAnalysis {
    constructor() {
        let elDataTable = null;
        let dataList = null;
        let modalEdit = null;
        let modalDelete = null;

        let listValue = null;

        let self = this;


        let bindElement = () => {
            $("#btn_add").unbind().click(function () {
                $("#addDataAnalysis").modal('show');
            });

            $("#btn_save").unbind().click(function () {
                addDataAnalysis();
            });

            $("#btn_show_values").unbind().click(function(){
                $("#list_value").show();
                showValues();
            });

            $("#refreshData").unbind().click(function(){
                self.showLastestDatatable();
            });
        };

        let createListValue = () => {
            let pathObject = getFlatObject(listValue[0]);
            let key = Object.keys(pathObject);
            let html = "";
            key.map(_key => {

                html += `   
                        <tr>
                            <td class="checkbox">
                                <input class="" type="checkbox" value="${_key}" name="value_key" checked>
                            </td>
                            <td>${_key}</td>
                            <td>${pathObject[_key]}</td>
                        </tr>
                        `;
            })
            $("#tbody_values").html(html);
        }
 
        let showValues = () => {
            $.ajax({
                url: '/js/company/testConvert.json',
                method:'GET',
                success:(res) => {
                    listValue = res;
                    createListValue();
                },
                error:(res) => {

                }

            })
        };

        let addDataAnalysis = () => {
            LOADING.set($("#btn_save"));
            let data_name = $("#data_name").val();
            let webservice_id = $("#datasource").val();
            let pathObject = [];
            $.each($("input[name='value_key']:checked"), function(){
                pathObject.push($(this).val());
            });
            $.ajax({
                url: END_POINT + API.create,
                method: 'POST',
                data: {
                    webservice_id : webservice_id,
                    pathArray : pathObject,
                    name: data_name,
                },
                success: (res) => {
                    $("#addDataAnalysis").modal('hide');
                    LOADING.reset($("#btn_save"));
                    this.showLastestDatatable();
                },
                error: (res) => {
                    LOADING.reset($("#btn_save"));
                }
            });
        };

        let updateDatatableData = () => {
            let Datatable = [];
            elDataTable.fnClearTable();

            dataList.map((item,index) => {
                let ret = [];
                ret[0] = item.name;
                ret[1] = item.fname + ' ' +item.lname;
                ret[2] = item.is_success ? `<div style="color:#00ce68"><i class="fas fa-check-circle"></i> Finished </div>` : `<div style="color:#ffaf00"><i class="fas fa-cog fa-spin"></i> Processing </div>`;
                ret[3] = `<center>
                            <button type="button" class="btn btn-primary btn-sm btn-lookup" key=${item.static_id} data-toggle="tooltip"
                                data-placement="top" title="Look">
                                <i class="fas fa-search"></i>
                            </button>
                            <button type="button" class="btn btn-success btn-sm btn-edit" index=${index}  data-toggle="tooltip"
                                data-placement="top" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-danger btn-sm btn-delete" index=${index}  data-toggle="tooltip"
                                data-placement="top" title="Delete">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                          </center>`;
                Datatable.push(ret);
            });

            if(Datatable.length > 0)
            elDataTable.fnAddData(Datatable);

            $(".btn-lookup").unbind().click(function () {
                onBtnLookupClick($(this).attr('key'));
            });


            $(".btn-delete").unbind().click(function () {
                onBtnDeleteClick($(this).attr('index'));
            });

            $('[data-toggle="tooltip"]').tooltip();
        };

        let onBtnLookupClick = (key) => {
            window.location.href = END_POINT_WED + "Company/Static/" + key;
        };

        let onBtnEditClick = (key) => {
            if (modalEdit === null) {
                modalEdit = `
                <div class="modal fade" id="editStatic">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Edit Static</h4>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>

                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-12">
                                        <label>Name</label>
                                        <input type="text" class="form-control" id="edit_static_name">
                                    </div>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="button" id="btn-edit-submit" class="btn btn-success btn-block" data-loading-text="<i class='fas fa-circle-notch fa-spin'></i> Saving . . .">Save</button>
                            </div>
                        </div>
                    </div>
                </div>`;

                $('body').append(modalEdit);
            }

            $("#btn-edit-submit").unbind().click(function () {
                onBtnSubmitEditClick(key);
            });



            $("#edit_static_name").val(dataList[key].name);
            $("#editStatic").modal('show');
        };

        let onBtnSubmitEditClick = (key) => {
            LOADING.set($("#btn-edit-submit"));
            $.ajax({
                url: END_POINT + 'company/static',
                method: 'PUT',
                data: {
                    static_id: dataList[key].static_id,
                    name: $("#edit_static_name").val(),
                },
                success: (res) => {
                    $("#editStatic").modal('hide');
                    LOADING.reset($("#btn-edit-submit"));
                    this.showLastestDatatable();
                },
                error: (res) => {
                    LOADING.reset($("#btn-edit-submit"));
                    console.log(res);
                }
            });
        };

        let onBtnDeleteClick = (key) => {
            if (modalDelete === null) {
                modalDelete = `
                <div class="modal fade" id="deleteStatic">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title">Delete Static</h4>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>

                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-12">
                                        Are you sure to delete static name : <span id="delete-static-name"></span> ?
                                    </div>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="button" id="btn-submit-delete" class="btn btn-danger btn-block" data-loading-text="<i class='fas fa-circle-notch fa-spin'></i> Saving . . .">Delete</button>
                            </div>
                        </div>
                    </div>
                </div>`;

                $('body').append(modalDelete);
            }

            $("#btn-submit-delete").unbind().click(function () {
                onBtnSubmitDeleteClick(key);
            });

            $("#delete-static-name").html(dataList[key].name);

            $("#deleteStatic").modal('show');
        };

        let onBtnSubmitDeleteClick = (key) => {
            LOADING.set($("#btn-submit-delete"));
            $.ajax({
                url: END_POINT + "company/static",
                method: "DELETE",
                data: {
                    static_id: staticList[key].static_id,
                },
                success: (res) => {
                    LOADING.reset($("#btn-submit-delete"));
                    $("#deleteStatic").modal('hide');
                    this.showLastestDatatable();
                },
                error: (res) => {
                    LOADING.reset($("#btn-submit-delete"));
                    console.log(res);
                }

            });
        };

        let initialDatatable = () => {
            if (elDataTable !== null) {
                return false;
            }
            elDataTable = $('#example').dataTable({});
        };

        let showDatatableLoadingStatus = (showOrHide) => {
            if (showOrHide) {
                $(".dataTables_wrapper").hide();
                $('#example').hide();
                $('.lds-roller').show();
            }
            else {
                $(".dataTables_wrapper").show();
                $('.lds-roller').hide();
                $('.text-loading').hide();
                $('#example').show();
                $('.text-static').show();
            }
        };

        this.initialAndRun = () => {
            bindElement();
            initialDatatable();
            this.showLastestDatatable();
        };

        this.showLastestDatatable = () => {
            showDatatableLoadingStatus(true);
            $.ajax({
                url: END_POINT + API.getAll,
                success: (res) => {
                    console.log(res);
                    showDatatableLoadingStatus(false);
                    dataList = res.data;
                    updateDatatableData();
                },
                error: (res) => {
                    showDatatableLoadingStatus(false);
                }
            });
        };
    }
}

$(document).ready(function () {
    let et = new DataAnalysis();
    et.initialAndRun();
    $('[data-toggle="tooltip"]').tooltip(); 
});

import WidgetObject from './WidgetObject.min.js'
import DataSource from './DataSource.min.js'
import viewModelInfographic from './viewModelInfographic.min.js'
import objectPath from 'object-path';
import chart from 'chartjs-plugin-zoom';
import {
  getFlatObject
} from '../../utility.js';
import {
  json2excel
} from 'js2excel'
import { LOADING,    
          checkError,
          checkAuthRes, 
          convertHex,
        } from '../../utility';

var path              = $("#pathImg").val();
var infoID            = $("#infoID").val();
var infoName          = $("#infoName").val();
var type_user         = $("#typeUser").val();
var company_id         = $("#company_id").val();
var CircularJSON      = window.CircularJSON;
var listInfoDatasource    = [];
let widgetObjectList  = [];
let deleteImagePath = [];

class Workspace {
  constructor() {
    /* Initial Function */
    this.initialAndRun = () => {
      $("#btn-add-datasource").unbind().click(function () {
        var datasourceModel = new DataSource();
        datasourceModel.DataSourceModel(infoID);
      });

      $("#btnGraph").unbind().click(function () {
        graphMenu();
        console.log("test");
      });

      $("#btnMap").unbind().click(function () {
        mapMenu();
      });

      $("#btnFont").unbind().click(function () {
        fontMenu();
      });

      $("#btnImage").unbind().click(function () {
        imageMenu();
      });

      $("#btnShapes").unbind().click(function () {
        shapesMenu();
      });

      $("#btn_save").unbind().click(function () {
        /* Update position widget data */
        for (var i = 0; i < widgetObjectList.length; i++) {
          if (widgetObjectList[i].type == "line" || widgetObjectList[i].type == "bar" || widgetObjectList[i].type == "pie" || widgetObjectList[i].type == "radar") {
            let graph = $("#canvas_" + widgetObjectList[i].id).data('graph');
            let graphWidget = $("#canvas_" + widgetObjectList[i].id);

            widgetObjectList[i].canvasTag = document.getElementById("div_canvas_" + widgetObjectList[i].id).outerHTML;

            let tempGraph = [];

            for(let j = 0; j < graph.data.datasets.length; j++)
            { 
              let temp = {
                label: graph.data.datasets[j].label,
                backgroundColor: graph.data.datasets[j].backgroundColor,
                borderColor: graph.data.datasets[j].borderColor
              }
              tempGraph.push(temp);
            }

            widgetObjectList[i].chartData = tempGraph;
            widgetObjectList[i].chartLabels = graph.data.labels;
        
            widgetObjectList[i].chartOption = [graph.options.scales.xAxes[0].scaleLabel.labelString, graph.options.scales.yAxes[0].scaleLabel.labelString];

            if(graphWidget.attr('state-mode') == "classic")
            {
              widgetObjectList[i].serviceList = graphWidget.attr("select-datasource-list");
            }
            else
            {
              widgetObjectList[i].serviceList = graphWidget.attr("select-datasource-list-series");
            }

          }
          else if (widgetObjectList[i].type == "map") {
            widgetObjectList[i].mapTag = document.getElementById("div_map_" + widgetObjectList[i].id).outerHTML;
          }
          else if (widgetObjectList[i].type == "head") {
            widgetObjectList[i].spanTag = document.getElementById("span_" + widgetObjectList[i].id).outerHTML;
          }
          else if (widgetObjectList[i].type == "table") {
            let tableWidget = $("#table_" + widgetObjectList[i].id);

            widgetObjectList[i].tableTag = document.getElementById("table_" + widgetObjectList[i].id).outerHTML;
            widgetObjectList[i].serviceList = tableWidget.attr("select-datasource-list");
          }
          else if (widgetObjectList[i].type == "image") {
            let temp_src = $("#image_" + widgetObjectList[i].id).attr('src');
            $("#image_" + widgetObjectList[i].id).attr('src', '');

            widgetObjectList[i].divImgTag = document.getElementById("div_" + widgetObjectList[i].id).outerHTML;

            $("#image_" + widgetObjectList[i].id).attr('src', temp_src);

            //Upload in storage

            let pathImage = null

            if(widgetObjectList[i].path != null)
            {
              pathImage = widgetObjectList[i].path;
            }

            $.ajax({
              url: END_POINT + 'infographic/uploadImage',
              method: 'POST',
              async:false,
              data: {
                  src_image: temp_src,
                  path_image: pathImage,
              },
              success: (res, textStatus, xhr) => {
                checkAuthRes(xhr);
                widgetObjectList[i].path = res.imageName;
              },
              error: (res) => {
                alert("error");
              }
            });
          }
          else if (widgetObjectList[i].type == "square" || widgetObjectList[i].type == "circle" || widgetObjectList[i].type == "string") {
            widgetObjectList[i].divTag = document.getElementById("div_" + widgetObjectList[i].id).outerHTML;
          }
        }

        /* Save info data to database  */
        $.ajax({
          url: END_POINT + 'infographic/updateInfoData',
          method: 'PUT',
          data: {
              info_id:   infoID,
              info_data: CircularJSON.stringify(widgetObjectList),
          },
          success: (res, textStatus, xhr) => {
            checkAuthRes(xhr);
            alert("success");
          },
          error: (res) => {
            alert("error");
          }
        });

        /* Remove image for delete widget */
        if(deleteImagePath.length > 0)
        {
          $.ajax({
            url: END_POINT + 'infographic/deleteImage',
            method: 'DELETE',
            data: {
                path_image: deleteImagePath,
            },
            success: (res, textStatus, xhr) => {
              checkAuthRes(xhr);
              console.log("delete image");
            },
            error: (res) => {
              alert("error");
            }
          });
        }

      }); //Btn save

      $("#btn_fullscreen").unbind().click(function () {
        var popup = window.open();
        popup.document.write("<h1 id='loading'>Loading...</h1>");

        //Set object for fullscreen
        $(".sPosition").removeClass("fCorner");
        $(".propertyMenu-2").html(``);

        //Generate to image
        html2canvas(document.querySelector("#workspace")).then(canvas => {
          var myImage = canvas.toDataURL("image/png");
          var img     = '<img src="' + myImage + '">';

          popup.document.write(img);
          popup.document.title = "Preview";
          popup.document.getElementById("loading").remove();
        }); //Html2canvas
      }); //Btn fullscreen

      $("#btn_download_list a").unbind().click(function () {
        var type = $(this).attr('valuetype');
        var popup = window.open();
        popup.document.write("<h1>Please wait for download...</h1>");

        //Set object for fullscreen
        $(".sPosition").removeClass("fCorner");
        $(".propertyMenu-2").html(``);

        //Generate to image
        html2canvas(document.querySelector("#workspace")).then(canvas => {
          popup.close();
          var myLinkImage = canvas.toDataURL("image/png");

          if(type == "pdf")
          {
            var pdf         = new jsPDF();
            var width       = pdf.internal.pageSize.getWidth();
            var height      = pdf.internal.pageSize.getHeight();
  
            pdf.addImage(myLinkImage, 'PNG', 0, 0, width, height);
            pdf.save(infoName + ".pdf");
          }
          else if(type == "image")
          {
            var a = document.createElement("a");
            a.href = myLinkImage;
            a.setAttribute("download", infoName + ".png");
            var b = document.createEvent("MouseEvents");
            b.initEvent("click", false, true);
            a.dispatchEvent(b);
          }

        }); //Html2canvas
      }); //Btn download

    }; // Initial and run

    /* Load widget data from database */
    this.loadWidgetData = (object, arrayService) => {
      for (var i = 0; i < object.length; i++) {
        if (object[i].type == "line" || object[i].type == "bar" || object[i].type == "pie" || object[i].type == "radar") {
          var Graphwidget = new Graph();
         
          let checkStatus = true;

          if(type_user == "COMPANY" && object[i].serviceList != null)
          {
            let serviceList = object[i].serviceList.split(',');

            for(let y = 0; y < serviceList.length; y++)
            {
              let result = arrayService.find(a => a === serviceList[y]);
              if(result == null && serviceList[y] != 0)
              {
                let lastChar = serviceList[y].split('_');
                if(lastChar[lastChar.length - 1] != company_id)
                {
                  checkStatus = false;
                  break;
                }
  
              }
            }
          }

          Graphwidget.loadGraphData(object[i].id, object[i].canvasTag, object[i].chartData, object[i].chartLabels, object[i].chartOption, object[i].type, checkStatus);
        }
        else if (object[i].type == "map") {
          var mapwidget = new Map();
          mapwidget.loadMapWidget(object[i].id, object[i].mapTag);
        }
        else if (object[i].type == "head") {
          var fontHead = new Font();
          fontHead.loadHeadGraph(object[i].id, object[i].spanTag);
        }
        else if (object[i].type == "table") {
          var fontHead = new Font();

          let checkStatus = true;
          console.log(object[i].serviceList);
          if(type_user == "COMPANY" && object[i].serviceList != null)
          {
            let serviceList = object[i].serviceList.split(',');

            for(let y = 0; y < serviceList.length; y++)
            {
              let result = arrayService.find(a => a === serviceList[y]);
              if(result == null && serviceList[y] != 0)
              {
                let lastChar = serviceList[y].split('_');
                if(lastChar[lastChar.length - 1] != company_id)
                {
                  checkStatus = false;
                  break;
                }
  
              }
            }
          }

          fontHead.loadTableWidget(object[i].id, object[i].tableTag, checkStatus);
        }
        else if (object[i].type == "image") {
          var imagewidget = new Imagesy();
          imagewidget.loadImageWidget(object[i].id, object[i].divImgTag, object[i].path);
        }
        else if (object[i].type == "square" || object[i].type == "circle" || object[i].type == "string") {
          var shapewidget = new Shape();
          shapewidget.loadShapeWidget(object[i].id, object[i].divTag, object[i].type);
        }
      }
    } // Load widget data

    /* Initial Element Action Function */
    var graphMenu = () => {
      if ($("#btnGraph").hasClass("actives")) {
        UnActive("btnGraph");
      }
      else {
        SetActive("btnGraph");

        $("#selectMenu").html(`
            <div class="row select-menu-2-context">
              <span>Add graph</span>
            </div>
            <div class="row select-menu-2-paper">
              <div id="g1" class="row select-menu-2-block">
                <img src="${path}/graph/line.png" class="image-back" style="width:60%; height:60%;"/>
                <div class="row select-menu-2-title"><span>Line</span></div>
                <div class="middle-center"><div class="text-popup">Insert</div></div>
              </div>
              <div id="g2" class="row select-menu-2-block">
                <img src="${path}/graph/bar.png" class="image-back" style="width:60%; height:60%;"/>
                <div class="row select-menu-2-title"><span>Bar</span></div>
                <div class="middle-center"><div class="text-popup">Insert</div></div>
              </div>
              <div id="g3" class="row select-menu-2-block">
                <img  src="${path}/graph/pie.png" class="image-back" style="width:60%; height:60%;"/>
                <div class="row select-menu-2-title"><span>Pie</span></div>
                <div class="middle-center"><div class="text-popup">Insert</div></div>
              </div>
              <div id="g4" class="row select-menu-2-block">
                <img  src="${path}/graph/radar.png" class="image-back" style="width:60%; height:60%;"/>
                <div class="row select-menu-2-title"><span>Radar</span></div>
                <div class="middle-center"><div class="text-popup">Insert</div></div>
              </div>
            </div>`);

        $("#g1").unbind().click(function () {
          var lineGraph = new Graph();
          lineGraph.createLineGraph();
        });

        $("#g2").unbind().click(function () {
          var barGraph = new Graph();
          barGraph.createBarGraph();
        });

        $("#g3").unbind().click(function () {
          var pieGraph = new Graph();
          pieGraph.createPieGraph();
        });

        $("#g4").unbind().click(function () {
          var radarGraph = new Graph();
          radarGraph.createRadarGraph();
        });
      }
    }

    var mapMenu = () => {
      if ($("#btnMap").hasClass("actives")) {
        UnActive("btnMap");
      }
      else {
        SetActive("btnMap");

        $("#selectMenu").html(`
            <div class="row select-menu-2-context">
              <span>Add map</span>
            </div>
            <div class="row select-menu-2-paper">
              <div id="m1" class="row select-menu-2-block">
                <img src="${path}/map/map.png" class="image-back" style="width:60%; height:60%;"/>
                <div class="row select-menu-2-title"><span>Thailand</span></div>
                <div class="middle-center"><div class="text-popup">Insert</div></div>
              </div>
            </div>`);

        $("#m1").unbind().click(function () {
          var mapWidget = new Map();
          mapWidget.createMapWidget();
        });

      }
    }

    var fontMenu = () => {
      if ($("#btnFont").hasClass("actives")) {
        UnActive("btnFont");
      }
      else {
        SetActive("btnFont");

        $("#selectMenu").html(`
            <div class="row select-menu-2-context">
              <span>Add text</span>
            </div>
            <div class="row select-menu-2-paper">
              <div id="f1" class="row select-menu-2-block">
                <img src="${path}/font/head.png" class="image-back" style="width:60%; height:60%;"/>
                <div class="row select-menu-2-title"><span>Title</span></div>
                <div class="middle-center"><div class="text-popup">Insert</div></div>
              </div>
              <div id="f2" class="row select-menu-2-block">
                <img src="${path}/font/subtitle.png" class="image-back" style="width:60%; height:60%;"/>
                <div class="row select-menu-2-title"><span>Subtitle</span></div>
                <div class="middle-center"><div class="text-popup">Insert</div></div>
              </div>
              <div id="f3" class="row select-menu-2-block">
                <img src="${path}/font/table.png" class="image-back" style="width:60%; height:60%;"/>
                <div class="row select-menu-2-title"><span>Table</span></div>
                <div class="middle-center"><div class="text-popup">Insert</div></div>
              </div>
            </div>`);

        $("#f1").unbind().click(function () {
          var fontHead = new Font();
          fontHead.createHeadGraph("title");
        });

        $("#f2").unbind().click(function () {
          var fontHead = new Font();
          fontHead.createHeadGraph("subtitle");
        });

        $("#f3").unbind().click(function () {
          var tableGraph = new Font();
          tableGraph.createTableGraph();
        });
      }
    }

    var imageMenu = () => {
      if ($("#btnImage").hasClass("actives")) {
        UnActive("btnImage");
      }
      else {
        SetActive("btnImage");

        $("#selectMenu").html(`
            <div class="row select-menu-2-context">
              <span>Add image</span>
            </div>
            <div class="row select-menu-2-paper">
              <div id="i1" class="row select-menu-2-block">
                <img src="${path}/image/browse.png" class="image-back" style="width:60%; height:60%;"/>
                <div class="row select-menu-2-title"><span>Browse</span></div>
                <div class="middle-center"><div class="text-popup">Insert</div></div>
              </div>
              <input type="file" id="inputfile_image" style="display:none;" />
            </div>`);

        $("#i1").unbind().click(function () {
          var imageWidget = new Imagesy();
          
          $("#inputfile_image").click();

          $('#inputfile_image').change(function () {
            var reader = new FileReader();
            reader.readAsDataURL($(this)[0].files[0]);
            reader.onload = function (e) 
            {
              imageWidget.createImageWidget(e.target.result);
              /*Reset button */
              $("#btnImage").click();
              $("#btnImage").click();
            }
          });
        });
      }
    }

    var shapesMenu = () => {
      if ($("#btnShapes").hasClass("actives")) {
        UnActive("btnShapes");
      }
      else {
        SetActive("btnShapes");

        $("#selectMenu").html(`
            <div class="row select-menu-2-context">
              <span>Add text</span>
            </div>
            <div class="row select-menu-2-paper">
              <div id="s1" class="row select-menu-2-block">
                <img src="${path}/shape/square.png" class="image-back" style="width:60%; height:60%;"/>
                <div class="row select-menu-2-title"><span>Square</span></div>
                <div class="middle-center"><div class="text-popup">Insert</div></div>
              </div>
              <div id="s2" class="row select-menu-2-block">
                <img src="${path}/shape/circle.png" class="image-back" style="width:60%; height:60%;"/>
                <div class="row select-menu-2-title"><span>Circle</span></div>
                <div class="middle-center"><div class="text-popup">Insert</div></div>
              </div>
              <div id="s3" class="row select-menu-2-block">
                <img src="${path}/shape/string.png" class="image-back" style="width:60%; height:60%;"/>
                <div class="row select-menu-2-title"><span>String</span></div>
                <div class="middle-center"><div class="text-popup">Insert</div></div>
              </div>
            </div>`);

        $("#s1").unbind().click(function () {
          var shapeWidget = new Shape();
          shapeWidget.createShapeWidget("square");
        });

        $("#s2").unbind().click(function () {
          var shapeWidget = new Shape();
          shapeWidget.createShapeWidget("circle");
        });

        $("#s3").unbind().click(function () {
          var shapeWidget = new Shape();
          shapeWidget.createShapeWidget("string");
        });
      }
    }

    /* Custom Function */
    var UnActive = (id) => {
      $("#" + id).removeClass("actives");
      $("#selectMenu").html(``);
      $("#selectMenu").hide();
    }

    var SetActive = (id) => {
      $("#selectMenu").show();
      $(".vertical-menu").find("a").removeClass("actives");
      $("#" + id).addClass("actives");
    }

  } // Constructor
} // Workspace

class Widget {
  constructor() {
    /* Create freetranform */
    this.createWidget = (id, typeid) => {
      var widgetObject = interact('#' + typeid + id)
        .draggable({
          autoScroll: true,
          inertia: true,
          restrict: {
            restriction: 'parent',
            endOnly: true,
            elementRect: { top: 0, left: 0, bottom: 1, right: 1 }
          },
        })
        .resizable({
          // resize from all edges and corners
          edges: {left: true, right: true, bottom: true, top: true},

          // keep the edges inside the parent
          restrictEdges: {
            outer: 'parent',
            endOnly: true,
          },

          // minimum size
          restrictSize: {
            min: { width: 100, height: 50 },
          },

          inertia: true,
        })
        .on('doubletap', function () {
          $(".sPosition").removeClass("fCorner");

          /* Clear property */
          $(".propertyMenu-2").html(``);

        })
        .on('resizemove', function (event) {
          changefocus(id, typeid);
          var target = event.target,
            x = (parseFloat(target.getAttribute('data-x')) || 0),
            y = (parseFloat(target.getAttribute('data-y')) || 0),
            z = (parseFloat(target.getAttribute('data-z')) || 0);

          // update the element's style
          target.style.width = event.rect.width + 'px';
          target.style.height = event.rect.height + 'px';

          //console.log(target);
          //$(target).attr('width', event.rect.width);
          //$(target).attr('height', event.rect.height);

          // translate when resizing from top or left edges
          x += event.deltaRect.left;
          y += event.deltaRect.top;

          target.style.webkitTransform = target.style.transform =
            'translate(' + x + 'px,' + y + 'px) rotate(' + z + 'deg)';

          target.setAttribute('data-x', x);
          target.setAttribute('data-y', y);
          target.setAttribute('data-z', z);

          $("#width_" + id).val(Math.round(event.rect.width));
          $("#height_" + id).val(Math.round(event.rect.height));
          $("#width_" + id).change();
          $("#height_" + id).change();
        });

      return widgetObject;
    }

    /* Custom function */
    let changefocus = (id, typeid) => {
      $(".sPosition").removeClass("fCorner");
      $('#' + typeid + id).addClass("fCorner");
    }

    this.clearfocus = () => {
      $(".sPosition").removeClass("fCorner");
    }
  }
}

/* Graph */
class Graph extends Widget {
  constructor() {
    super();
    this.createLineGraph = () => {
      var id = Math.floor(100000 + Math.random() * 900000);
      this.clearfocus();

      $("#workspace").append(`<div id="div_canvas_${id}" class="sPosition fCorner"><canvas id="canvas_${id}" state-mode="classic" maiden-check="true" area-check="false"/></div>`);

      var speedData = 
      {
        datasets: [
          {
            label:'Demo Data 1',
            data: [
              {x: new Date('2000','02','20'), y:25},
              {x: new Date('2001','02','21'), y:50},
              {x: new Date('2002','02','22'), y:75},
              {x: new Date('2003','02','23'), y:100}],
              backgroundColor: 'rgba(255, 255, 255, 0)',
              borderColor: '#05acd3'
          }, 
          {
            label:'Demo Data 2',
            data: [
              {x: new Date('2002','04','10'), y:10},
              {x: new Date('2003','04','11'), y:20},
              {x: new Date('2004','04','12'), y:30},
              {x: new Date('2005','04','13'), y:40}],
              backgroundColor: 'rgba(255, 255, 255, 0)',
              borderColor: '#00ce68'
          }]
      };

      let chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
          display: true,
          position: 'top',
          labels: {
            boxWidth: 80,
            fontColor: 'black'
          }
        },
        scales: {
            xAxes: [{
                type: 'time',
                distribution: 'linear',
                ticks:{
                  source:'auto'
                },
                scaleLabel: {
                  display: true,
                  labelString: 'X Label'
                }
            }],
            yAxes: [{
              scaleLabel: {
                display: true,
                labelString: 'Y Label'
              }
            }],
        },
        zoom: {
          enabled: true,
          drag: false,
          mode: "x",
          limits: {
            max: 12,
            min: 5
          }
        }
      };

      let ctx = $("#canvas_" + id);
      var myChart = new Chart(ctx, {
        type: 'line',
        data: speedData,
        options: chartOptions
      });

      ctx.data("graph", myChart);
      
      /* Clear other property */
      $(".propertyMenu-2").html(``);

      var property = new ContentProperty();
      property.createGraphProp(id, myChart, "#div_canvas_" + id, "line");

      /* Click each widget event */
      var widgetObject = this.createWidget(id, "div_canvas_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#div_canvas_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createGraphProp(id, myChart, "#div_canvas_" + id, "line");
      })
        .on('dragmove', function (event) {
          /* Change focus */
          $(".sPosition").removeClass("fCorner");
          $("#div_canvas_" + id).addClass("fCorner");

          var target = event.target,
            // keep the dragged position in the data-x/data-y attributes
            x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
            y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
            z = (parseFloat(target.getAttribute('data-z')) || 0);

          // translate the element
          target.style.webkitTransform =
            target.style.transform =
            'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

          // update the posiion attributes
          target.setAttribute('data-x', x);
          target.setAttribute('data-y', y);
          target.setAttribute('data-z', z);

          /* Clear other property */
          $(".propertyMenu-2").html(``);

          var property = new ContentProperty();
          property.createGraphProp(id, myChart, "#div_canvas_" + id, "line");
        })

      /* Save widget */
      let saveObject = new WidgetObject();
      console.log(myChart.options);
      saveObject.WidgetGraphObject(id, null, null, null, null, "line", null);
      console.log(saveObject.chartOption);
      widgetObjectList.push(saveObject);
      widgetObjectList = deepCopy(widgetObjectList);    
      console.log(widgetObjectList[0].chartOption);
    }

    this.createBarGraph = () => {
      var id = Math.floor(100000 + Math.random() * 900000);
      this.clearfocus();

      $("#workspace").append(`<div id="div_canvas_${id}" class="sPosition fCorner"><canvas id="canvas_${id}" state-mode="classic" maiden-check="true"/></div>`);

      var speedData = 
      {
        datasets: [
          {
            label:'Demo Data 1',
            data: [
              {x: new Date('2000','02','20'), y:25},
              {x: new Date('2001','02','21'), y:50},
              {x: new Date('2002','02','22'), y:75},
              {x: new Date('2003','02','23'), y:100}],
              backgroundColor: '#05acd3',
          }, 
          {
            label:'Demo Data 2',
            data: [
              {x: new Date('2002','04','10'), y:10},
              {x: new Date('2003','04','11'), y:20},
              {x: new Date('2004','04','12'), y:30},
              {x: new Date('2005','04','13'), y:40}],
              backgroundColor: '#00ce68',
          }]
      };

      let chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
          display: true,
          position: 'top',
          labels: {
            boxWidth: 80,
            fontColor: 'black'
          }
        },
        scales: {
            xAxes: [{
                type: 'time',
                distribution: 'linear',
                ticks:{
                  source:'auto'
                },
                scaleLabel: {
                  display: true,
                  labelString: 'X Label'
                }
            }],
            yAxes: [{
              scaleLabel: {
                display: true,
                labelString: 'Y Label'
              }
            }],
        },
        zoom: {
          enabled: true,
          drag: false,
          mode: "x",
          limits: {
            max: 12,
            min: 5
          }
        }
      };

      let ctx = $("#canvas_" + id);
      var myChart = new Chart(ctx, {
        type: 'bar',
        data: speedData,
        options: chartOptions
      });

      ctx.data("graph", myChart);

      /* Clear other property */
      $(".propertyMenu-2").html(``);

      var property = new ContentProperty();
      property.createGraphProp(id, myChart, "#div_canvas_" + id, "bar");

      /* Click each widget event */
      var widgetObject = this.createWidget(id, "div_canvas_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#div_canvas_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createGraphProp(id, myChart, "#div_canvas_" + id, "bar");
      })
      .on('dragmove', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#div_canvas_" + id).addClass("fCorner");

        var target = event.target,
        // keep the dragged position in the data-x/data-y attributes
        x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
        y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
        z = (parseFloat(target.getAttribute('data-z')) || 0);

      // translate the element
      target.style.webkitTransform =
        target.style.transform =
        'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

      // update the posiion attributes
      target.setAttribute('data-x', x);
      target.setAttribute('data-y', y);
      target.setAttribute('data-z', z);

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createGraphProp(id, myChart, "#div_canvas_" + id, "bar");
      })

      /* Save widget */
      let saveObject = new WidgetObject();
      console.log(myChart.options);
      saveObject.WidgetGraphObject(id, null, null, null, null, "bar", null);
      console.log(saveObject.chartOption);
      widgetObjectList.push(saveObject);
      widgetObjectList = deepCopy(widgetObjectList);    
      console.log(widgetObjectList[0].chartOption);
    }

    this.createPieGraph = () => {
      var id = Math.floor(100000 + Math.random() * 900000);
      this.clearfocus();

      $("#workspace").append(`<div id="div_canvas_${id}" class="sPosition fCorner"><canvas id="canvas_${id}" state-mode="classic" maiden-check="true"/></div>`);

      var speedData = {
        labels: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
        datasets: [{
          label: "Demo Data 1",
          data: [0, 59, 75, 20, 20, 55, 40],
          backgroundColor: '#05acd3'
        }, {
          label: "Demo Data 2",
          data: [0, 29, 25, 20, 20, 25, 20],
          backgroundColor: '#00ce68'
        }]
      };

      var chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
          display: true,
          position: 'top',
          labels: {
            boxWidth: 80,
            fontColor: 'black'
          }
        },
        scales: {
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Y Label'
            }
          }],
          xAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'X Label'
            }
          }],
        }
      };

      let ctx = $("#canvas_" + id);
      var myChart = new Chart(ctx, {
        type: 'pie',
        data: speedData,
        options: chartOptions
      });

      ctx.data("graph", myChart);

      /* Clear other property */
      $(".propertyMenu-2").html(``);

      var property = new ContentProperty();
      property.createGraphProp(id, myChart, "#div_canvas_" + id, "pie");

      /* Click each widget event */
      var widgetObject = this.createWidget(id, "div_canvas_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#div_canvas_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createGraphProp(id, myChart, "#div_canvas_" + id, "pie");
      })
      .on('dragmove', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#div_canvas_" + id).addClass("fCorner");

        var target = event.target,
        // keep the dragged position in the data-x/data-y attributes
        x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
        y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
        z = (parseFloat(target.getAttribute('data-z')) || 0);

      // translate the element
      target.style.webkitTransform =
        target.style.transform =
        'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

      // update the posiion attributes
      target.setAttribute('data-x', x);
      target.setAttribute('data-y', y);
      target.setAttribute('data-z', z);

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createGraphProp(id, myChart, "#div_canvas_" + id, "pie");
      })

      /* Save widget */
      let saveObject = new WidgetObject();
      console.log(myChart.options);
      saveObject.WidgetGraphObject(id, null, null, null, null, "pie", null);
      console.log(saveObject.chartOption);
      widgetObjectList.push(saveObject);
      widgetObjectList = deepCopy(widgetObjectList);    
      console.log(widgetObjectList[0].chartOption);
    }

    this.createRadarGraph = () => {
      var id = Math.floor(100000 + Math.random() * 900000);
      this.clearfocus();

      $("#workspace").append(`<div id="div_canvas_${id}" class="sPosition fCorner"><canvas id="canvas_${id}" state-mode="classic" maiden-check="true"/></div>`);

      var speedData = {
        labels: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
        datasets: [{
          label: "Demo Data 1",
          data: [0, 59, 75, 20, 20, 55, 40],
          backgroundColor: 'rgba(255, 255, 255, 0)',
          borderColor: '#05acd3'
        }, {
          label: "Demo Data 2",
          data: [0, 29, 25, 20, 20, 25, 20],
          backgroundColor: 'rgba(255, 255, 255, 0)',
          borderColor: '#00ce68'
        }]
      };

      var chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        legend: {
          display: true,
          position: 'top',
          labels: {
            boxWidth: 80,
            fontColor: 'black'
          }
        },
        scales: {
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Y Label'
            }
          }],
          xAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'X Label'
            }
          }],
        }
      };

      let ctx = $("#canvas_" + id);
      var myChart = new Chart(ctx, {
        type: 'radar',
        data: speedData,
        options: chartOptions
      });

      ctx.data("graph", myChart);
      
      /* Clear other property */
      $(".propertyMenu-2").html(``);

      var property = new ContentProperty();
      property.createGraphProp(id, myChart, "#div_canvas_" + id, "radar");

      /* Click each widget event */
      var widgetObject = this.createWidget(id, "div_canvas_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#div_canvas_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createGraphProp(id, myChart, "#div_canvas_" + id, "radar");
      })
      .on('dragmove', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#div_canvas_" + id).addClass("fCorner");

        var target = event.target,
        // keep the dragged position in the data-x/data-y attributes
        x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
        y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
        z = (parseFloat(target.getAttribute('data-z')) || 0);

      // translate the element
      target.style.webkitTransform =
        target.style.transform =
        'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

      // update the posiion attributes
      target.setAttribute('data-x', x);
      target.setAttribute('data-y', y);
      target.setAttribute('data-z', z);

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createGraphProp(id, myChart, "#div_canvas_" + id, "radar");
      })

      /* Save widget */
      let saveObject = new WidgetObject();
      console.log(myChart.options);
      saveObject.WidgetGraphObject(id, null, null, null, null, "radar", null);
      console.log(saveObject.chartOption);
      widgetObjectList.push(saveObject);
      widgetObjectList = deepCopy(widgetObjectList);    
      console.log(widgetObjectList[0].chartOption);
    }

    this.loadGraphData = (id, canvasTag, chartData, chartLabels, chartOptions, chartType, checkStatus) => {
      this.clearfocus();
      $("#workspace").append(canvasTag);

      let myChart2;
      let ctx = $("#canvas_" + id);
      let chartOptions2;

      if(ctx.attr('state-mode') == "series" || chartType == "line" || chartType == "bar")
      {
        chartOptions2 = {
          responsive: true,
          maintainAspectRatio: false,
          legend: {
            display: true,
            position: 'top',
            labels: {
              boxWidth: 80,
              fontColor: 'black'
            }
          },
          scales: {
              xAxes: [{
                  type: 'time',
                  distribution: 'linear',
                  ticks:{
                    source:'auto'
                  },
                  scaleLabel: {
                    display: true,
                    labelString: chartOptions[0]
                  }
              }],
              yAxes: [{
                scaleLabel: {
                  display: true,
                  labelString: chartOptions[1]
                }
              }],
          },
          zoom: {
            enabled: true,
            drag: false,
            mode: "x",
            limits: {
              max: 12,
              min: 5
            }
          }
        };
      }
      else
      {
        chartOptions2 = {
          responsive: true,
          maintainAspectRatio: false,
          legend: {
            display: true,
            position: 'top',
            labels: {
              boxWidth: 80,
              fontColor: 'black'
            }
          },
          scales: {
            yAxes: [{
              scaleLabel: {
                display: true,
                labelString: chartOptions[1]
              }
            }],
            xAxes: [{
              scaleLabel: {
                display: true,
                labelString: chartOptions[0]
              }
            }],
          }
        };
      }

      myChart2 = new Chart(ctx, {
        type: chartType,
        data: [],
        options: chartOptions2
      });

      let ctx2 = $("#div_canvas_" + id);

      if(checkStatus == false)
      {
        ctx2.addClass("sensor-color");
        ctx.addClass("sensor-hidden");
      }
      else
      {
        ctx2.removeClass("sensor-color");
        ctx.removeClass("sensor-hidden");
      }

      //Get lastest data

      if(ctx.attr('maiden-check') == "false")
      {
        if(ctx.attr('state-mode') == "classic")
        {
          let keylist = ctx.attr('select-keydata-list').split(',');
          let namelist = ctx.attr('select-dwname-list').split(',');
          let getTypeApi = checkTypeApi(ctx.attr('period-type'));
  
          for(let m = 0; m < keylist.length; m++)
          {
            if(namelist[m] != 0)
            {
              $.ajax({
                url: API_DW + 'iotService/getInputAggregationForWeb',
                async:false,
                method: 'POST',
                data: {
                  type: getTypeApi,
                  nameDW: namelist[m],
                  end_date: ctx.attr('end-value'),
                  start_date: ctx.attr('start-value')
                },
                success: (res, textStatus, xhr) => {
                  checkAuthRes(xhr);
               
                  let tList = [];
  
                  if(chartType == "line" || chartType == "bar")
                  {
                    for(let i = 0; i < res.length; i++)
                    {
                      let dateApi = res[i]["real_date"];
        
                      let t = {x: dateApi, y: objectPath.get(res[i], keylist[m])};
                      tList.push(t);
                    }
                  }
                  else
                  {
                    addLabel(myChart2, chartLabels);
  
                    for(let i = 0; i < res.length; i++)
                    {
                      for(let j = 0; j < myChart2.data.labels.length; j++)
                      {
                        let dateApi = moment(res[i]["real_date"]).format('YYYY-MM-DD').toString();
    
                        if(myChart2.data.labels[j] == dateApi)
                        {
                          let t = objectPath.get(res[i], keylist[m]);
                          tList.push(t);
                          break;
                        }
                      }
                    }
                  }
  
                  let newData =
                  {
                    label: chartData[m].label,
                    data: tList,
                    backgroundColor: chartData[m].backgroundColor,
                    borderColor: chartData[m].borderColor
                  };
          
                  myChart2.data.datasets.push(newData);        
                  myChart2.update();
      
                },
                error: (res) => {
                  console.log(res);
                }
              });
            }
          }
        }
        else
        {
          let keylist = ctx.attr('select-keydata-list-series').split(',');
          let namelist = ctx.attr('select-dwname-list-series').split(',');
          let period = getLengthDate(ctx.attr('series-type'));

          for(let m = 0; m < keylist.length; m++)
          {
            if(namelist[m] != 0)
            {
              $.ajax({
                url: API_DW + 'iotService/getInputIoTData_Time',
                async:false,
                method: 'POST',
                data: {
                  tableDW_name: namelist[m],
                  end_date: period[1],
                  start_date: period[0]
                },
                success: (res, textStatus, xhr) => {
                  checkAuthRes(xhr);
    
                  let tList = [];
    
                  for(let i = 0; i < res.length; i++)
                  {
                    let dateApi = res[i].newDate;
      
                    let t = {x: dateApi, y: objectPath.get(res[i], keylist[m])};
                    tList.push(t);
                  }
    
                  let newData =
                  {
                    label: chartData[m].label,
                    data: tList,
                    backgroundColor: chartData[m].backgroundColor,
                    borderColor: chartData[m].borderColor
                  };
          
                  myChart2.data.datasets.push(newData);        
                  myChart2.update();
      
                },
                error: (res) => {
                  console.log(res);
                }
              });
            }
          }
        }
      }
      else
      {
        addLabel(myChart2, chartLabels);
        addDatasets(myChart2, chartData);
      }

      ctx.data("graph", myChart2);

      /* Clear other property */
      $(".propertyMenu-2").html(``);
      this.clearfocus();

      /* Click each widget event */
      var widgetObject = this.createWidget(id, "div_canvas_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#div_canvas_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createGraphProp(id, myChart2, "#div_canvas_" + id, chartType);
      })
        .on('dragmove', function (event) {
          /* Change focus */
          $(".sPosition").removeClass("fCorner");
          $("#div_canvas_" + id).addClass("fCorner");

          var target = event.target,
          // keep the dragged position in the data-x/data-y attributes
          x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
          y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
          z = (parseFloat(target.getAttribute('data-z')) || 0);

        // translate the element
        target.style.webkitTransform =
          target.style.transform =
          'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

        // update the posiion attributes
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
        target.setAttribute('data-z', z);

          /* Clear other property */
          $(".propertyMenu-2").html(``);

          var property = new ContentProperty();
          property.createGraphProp(id, myChart2, "#div_canvas_" + id, chartType);
        })

      /* Save widget */
      let saveObject = new WidgetObject();
      saveObject.WidgetGraphObject(id, null, null, null, null, chartType, null);
      widgetObjectList.push(saveObject);
      widgetObjectList = deepCopy(widgetObjectList);    
    }

    let addLabel = (chart, labels) => {
      for (var i = 0; i < labels.length; i++) {
        chart.data.labels.push(labels[i]);
      }
      chart.update();
    }

    let addDatasets = (chart, dataSets) => {
      for (var i = 0; i < dataSets.length; i++) {
        var newData =
        {
          label: dataSets[i].label,
          data: dataSets[i].data,
          backgroundColor: dataSets[i].backgroundColor,
          borderColor: dataSets[i].borderColor
        };

        chart.data.datasets.push(newData);
      }
      chart.update();
    }
  }
} //Widget class

class Map extends Widget
{
  constructor()
  {
    super();
    this.createMapWidget = () => 
    {
      var id = Math.floor(100000 + Math.random() * 900000);
      this.clearfocus();

      $("#workspace").append(`<div id="div_map_${id}" class="sPosition fCorner crispyOutter"><div id="map_${id}" class="crispyInner"></div></div>`);

      $('#map_' + id).css('height', 300);
      $('#map_' + id).css('width', 300);

      let mymap;
      let mapid = "map_" + id;

      mymap = L.map(mapid, {
        dragging: true,
        zoomControl: true,
        scrollWheelZoom: false,
        zoomAnimation: false,
      });

      $.getJSON('https://raw.githubusercontent.com/apisit/thailand.json/master/thailand.json').then(function (geoJSON) {
        var osm = new L.TileLayer.BoundaryCanvas("https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}", {
            boundary: geoJSON,
            minZoom: 5,
            maxZoom: 9,
            attribution: '&copy; Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ'
        });

        mymap.addLayer(osm);
        var ukLayer = L.geoJSON(geoJSON);
        mymap.fitBounds(ukLayer.getBounds());
      });

      // mymap.on('mouseover', console.log("in"));
      // mymap.on('mouseout', console.log("out"));

      /* Clear other property */
      $(".propertyMenu-2").html(``);

      var property = new ContentProperty();
      property.createMapProp(id, "#div_map_" + id, "map", mymap);

      /* Click each widget event */
      var widgetObject = this.createWidget(id, "div_map_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#div_map_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createMapProp(id, "#div_map_" + id, "map", mymap);
      })
        .on('dragmove', function (event) {
          /* Change focus */
          $(".sPosition").removeClass("fCorner");
          $("#div_map_" + id).addClass("fCorner");

          var target = event.target,
          // keep the dragged position in the data-x/data-y attributes
          x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
          y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
          z = (parseFloat(target.getAttribute('data-z')) || 0);

        // translate the element
        target.style.webkitTransform =
          target.style.transform =
          'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

        // update the posiion attributes
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
        target.setAttribute('data-z', z);

          /* Clear other property */
          $(".propertyMenu-2").html(``);

          var property = new ContentProperty();
          property.createMapProp(id, "#div_map_" + id, "map", mymap);
        })

      /* Save widget */
      let saveObject = new WidgetObject();
      saveObject.MapWidgetObject(id, null, "map");
      widgetObjectList.push(saveObject);
    }

    this.loadMapWidget = (id, mapTag) => {
      this.clearfocus();

      $("#workspace").append(mapTag);

      $('#map_' + id).css('height', 300);
      $('#map_' + id).css('width', 300);

      let mymap;
      let mapid = "map_" + id;

      mymap = L.map(mapid, {
        dragging: true,
        zoomControl: true,
        scrollWheelZoom: false,
        zoomAnimation: false,
      });

      $.getJSON('https://raw.githubusercontent.com/apisit/thailand.json/master/thailand.json').then(function (geoJSON) {
        var osm = new L.TileLayer.BoundaryCanvas("https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}", {
            boundary: geoJSON,
            minZoom: 5,
            maxZoom: 9,
            attribution: '&copy; Tiles &copy; Esri &mdash; Esri, DeLorme, NAVTEQ'
        });

        mymap.addLayer(osm);
        var ukLayer = L.geoJSON(geoJSON);
        mymap.fitBounds(ukLayer.getBounds());
      });

      /* Clear other property */
      $(".propertyMenu-2").html(``);
      this.clearfocus();

      /* Click each widget event */
       /* Click each widget event */
      var widgetObject = this.createWidget(id, "div_map_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#div_map_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createMapProp(id, "#div_map_" + id, "map", mymap);
      })
        .on('dragmove', function (event) {
          /* Change focus */
          $(".sPosition").removeClass("fCorner");
          $("#div_map_" + id).addClass("fCorner");

          var target = event.target,
          // keep the dragged position in the data-x/data-y attributes
          x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
          y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
          z = (parseFloat(target.getAttribute('data-z')) || 0);

        // translate the element
        target.style.webkitTransform =
          target.style.transform =
          'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

        // update the posiion attributes
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
        target.setAttribute('data-z', z);

          /* Clear other property */
          $(".propertyMenu-2").html(``);

          var property = new ContentProperty();
          property.createMapProp(id, "#div_map_" + id, "map", mymap);
        })

      /* Save widget */
      let saveObject = new WidgetObject();
      saveObject.MapWidgetObject(id, null, "map");
      widgetObjectList.push(saveObject);
    }
  }
}

/* Font */
class Font extends Widget {
  constructor() {
    super();
    this.createHeadGraph = (type) => {
      var id = Math.floor(100000 + Math.random() * 900000);
      this.clearfocus();

      if(type == "title")
      {
        $("#workspace").append(`<span id="span_${id}" class="sPosition fCorner" style="font-size: 100px;">Title</span>`);
      }
      else if(type == "subtitle")
      {
        $("#workspace").append(`<span id="span_${id}" class="sPosition fCorner" style="font-size: 40px; color: rgb(73, 73, 73);">subtitle</span>`);
      }
      
      /* Clear other property */
      $(".propertyMenu-2").html(``);

      var property = new ContentProperty();
      property.createTextProp(id, "#span_" + id, "text");

      /* Click each widget event */
      var widgetObject = this.createWidget(id, "span_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#span_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createTextProp(id, "#span_" + id, "text");
      })
        .on('dragmove', function (event) {
          /* Change focus */
          $(".sPosition").removeClass("fCorner");
          $("#span_" + id).addClass("fCorner");

          var target = event.target,
          // keep the dragged position in the data-x/data-y attributes
          x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
          y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
          z = (parseFloat(target.getAttribute('data-z')) || 0);

        // translate the element
        target.style.webkitTransform =
          target.style.transform =
          'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

        // update the posiion attributes
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
        target.setAttribute('data-z', z);

          /* Clear other property */
          $(".propertyMenu-2").html(``);

          var property = new ContentProperty();
          property.createTextProp(id, "#span_" + id, "text");
        })

      /* Save widget */
      let saveObject = new WidgetObject();
      saveObject.HeadFontObject(id, null, "head");
      widgetObjectList.push(saveObject);
    }

    this.loadHeadGraph = (id, spanTag) => {
      this.clearfocus();

      $("#workspace").append(spanTag);

      /* Clear other property */
      $(".propertyMenu-2").html(``);
      this.clearfocus();

      /* Click each widget event */
      var widgetObject = this.createWidget(id, "span_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#span_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createTextProp(id, "#span_" + id, "text");
      })
        .on('dragmove', function (event) {
          /* Change focus */
          $(".sPosition").removeClass("fCorner");
          $("#span_" + id).addClass("fCorner");

          var target = event.target,
          // keep the dragged position in the data-x/data-y attributes
          x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
          y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
          z = (parseFloat(target.getAttribute('data-z')) || 0);

        // translate the element
        target.style.webkitTransform =
          target.style.transform =
          'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

        // update the posiion attributes
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
        target.setAttribute('data-z', z);

          /* Clear other property */
          $(".propertyMenu-2").html(``);

          var property = new ContentProperty();
          property.createTextProp(id, "#span_" + id, "text");
        })

      /* Save widget */
      let saveObject = new WidgetObject();
      saveObject.HeadFontObject(id, null, "head");
      widgetObjectList.push(saveObject);
    }

    this.createTableGraph = () => {
      var id = Math.floor(100000 + Math.random() * 900000);
      this.clearfocus();

      $("#workspace").append(`
                                <table id="table_${id}" class="sPosition fCorner table" table-class="1" maiden-check="true">
                                  <tr>
                                    <th>*</th>
                                    <th>Column</th>
                                    <th>Column</th>
                                  </tr>
                                  <tr>
                                    <td>Date</td>
                                    <td>###</td>
                                    <td>###</td>
                                  </tr>
                                  <tr>
                                    <td>Date</td>
                                    <td>###</td>
                                    <td>###</td>
                                  </tr>
                                </table>
                              `);

        // const editor = new SimpleTableCellEditor("table_" + id);
        // editor.SetEditable("td",{
        //   keys : {
        //   validation: [13],
        //   cancellation: [27]
        //   }
        // });

        // editor.SetEditable("th",{
        //   keys : {
        //   validation: [13],
        //   cancellation: [27]
        //   }
        // });

      /* Clear other property */
      $(".propertyMenu-2").html(``);

      var property = new ContentProperty();
      property.createTableProp(id, "#table_" + id, "table");

      /* Click each widget event */
      var widgetObject = this.createWidget(id, "table_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#table_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createTableProp(id, "#table_" + id, "table");
      })
        .on('dragmove', function (event) {
          /* Change focus */
          $(".sPosition").removeClass("fCorner");
          $("#table_" + id).addClass("fCorner");

          var target = event.target,
          // keep the dragged position in the data-x/data-y attributes
          x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
          y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
          z = (parseFloat(target.getAttribute('data-z')) || 0);

        // translate the element
        target.style.webkitTransform =
          target.style.transform =
          'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

        // update the posiion attributes
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
        target.setAttribute('data-z', z);

          /* Clear other property */
          $(".propertyMenu-2").html(``);

          var property = new ContentProperty();
          property.createTableProp(id, "#table_" + id, "table");
        })

      /* Save widget */
      let saveObject = new WidgetObject();
      saveObject.WidgetTableObject(id, null, "table", null);
      widgetObjectList.push(saveObject);
    }

    this.loadTableWidget = (id, tableTag, checkStatus) => {
      this.clearfocus();

      $("#workspace").append(tableTag);

      let ctx = $("#table_" + id);
      console.log(checkStatus);
      if(checkStatus == false)
      {
        ctx.find('tbody').css('display', 'none');
        ctx.addClass("sensor-color");
      }
      else
      {
        ctx.find('tbody').css('display', '');
        ctx.removeClass("sensor-color");
      }

      // const editor = new SimpleTableCellEditor("table_" + id);
      // editor.SetEditable("td",{
      //   keys : {
      //   validation: [13],
      //   cancellation: [27]
      //   }
      // });

      // editor.SetEditable("th",{
      //   keys : {
      //   validation: [13],
      //   cancellation: [27]
      //   }
      // });

      /* Clear other property */
      $(".propertyMenu-2").html(``);
      this.clearfocus();

      /* Click each widget event */
      var widgetObject = this.createWidget(id, "table_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#table_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createTableProp(id, "#table_" + id, "table");
      })
        .on('dragmove', function (event) {
          /* Change focus */
          $(".sPosition").removeClass("fCorner");
          $("#table_" + id).addClass("fCorner");

          var target = event.target,
          // keep the dragged position in the data-x/data-y attributes
          x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
          y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
          z = (parseFloat(target.getAttribute('data-z')) || 0);

        // translate the element
        target.style.webkitTransform =
          target.style.transform =
          'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

        // update the posiion attributes
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
        target.setAttribute('data-z', z);

          /* Clear other property */
          $(".propertyMenu-2").html(``);

          var property = new ContentProperty();
          property.createTableProp(id, "#table_" + id, "table");
        })

      /* Save widget */
      let saveObject = new WidgetObject();
      saveObject.WidgetTableObject(id, null, "table", null);
      widgetObjectList.push(saveObject);
    }
  } //Constructor
} //Font class

class Imagesy extends Widget{
  constructor(){
    super();
    this.createImageWidget = (src_image) => {
      var id = Math.floor(100000 + Math.random() * 900000);
      this.clearfocus();

      $("#workspace").append(`<div id="div_${id}" class="sPosition fCorner"><img id="image_${id}" src="${src_image}" class="scaleImage" /></div>`);
      
      $('#div_' + id).css('height', 150);
      $('#div_' + id).css('width', 150);

      /* Clear other property */
      $(".propertyMenu-2").html(``);

      var property = new ContentProperty();
      property.createImageProp(id, "#div_" + id, "#image_" + id, "image", null);

      /* Click each widget event */
      var widgetObject = this.createWidget(id, "div_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#div_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createImageProp(id, "#div_" + id, "#image_" + id, "image", null);
      })
        .on('dragmove', function (event) {
          /* Change focus */
          $(".sPosition").removeClass("fCorner");
          $("#div_" + id).addClass("fCorner");

          var target = event.target,
          // keep the dragged position in the data-x/data-y attributes
          x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
          y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
          z = (parseFloat(target.getAttribute('data-z')) || 0);

        // translate the element
        target.style.webkitTransform =
          target.style.transform =
          'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

        // update the posiion attributes
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
        target.setAttribute('data-z', z);

          /* Clear other property */
          $(".propertyMenu-2").html(``);

          var property = new ContentProperty();
          property.createImageProp(id, "#div_" + id, "#image_" + id, "image", null);
        })

      /* Save widget */
      let saveObject = new WidgetObject();
      saveObject.WidgetImageObject(id, null, "image", null);
      widgetObjectList.push(saveObject);
    }   

    this.loadImageWidget = (id, divImgTag, path) => {
      this.clearfocus();
      $("#workspace").append(divImgTag);
      
      toDataUrl(END_POINT + 'infographic/getImage?path_image=' + path, function(myBase64) {
        $("#image_" + id).attr('src', myBase64);
    });

      /* Clear other property */
      $(".propertyMenu-2").html(``);

      var property = new ContentProperty();
      property.createImageProp(id, "#div_" + id, "#image_" + id, "image", path);

      /* Click each widget event */
      var widgetObject = this.createWidget(id, "div_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#div_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createImageProp(id, "#div_" + id, "#image_" + id, "image", path);
      })
        .on('dragmove', function (event) {
          /* Change focus */
          $(".sPosition").removeClass("fCorner");
          $("#div_" + id).addClass("fCorner");

          var target = event.target,
          // keep the dragged position in the data-x/data-y attributes
          x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
          y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
          z = (parseFloat(target.getAttribute('data-z')) || 0);

        // translate the element
        target.style.webkitTransform =
          target.style.transform =
          'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

        // update the posiion attributes
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
        target.setAttribute('data-z', z);

          /* Clear other property */
          $(".propertyMenu-2").html(``);

          var property = new ContentProperty();
          property.createImageProp(id, "#div_" + id, "#image_" + id, "image", path);
        })

      /* Save widget */
      let saveObject = new WidgetObject();
      saveObject.WidgetImageObject(id, null, "image", path);
      widgetObjectList.push(saveObject);
    }
  } //Constructor
} //Image class

class Shape extends Widget{
  constructor(){
    super();
    this.createShapeWidget = (type) => {
      var id = Math.floor(100000 + Math.random() * 900000);
      this.clearfocus();

      if(type == "square")
      {
        $("#workspace").append(`<div id="div_${id}" class="sPosition fCorner"><div id="shape_${id}" class="square"></div></div>`);
      }
      else if(type == "circle")
      {
        $("#workspace").append(`<div id="div_${id}" class="sPosition fCorner"><div id="shape_${id}" class="circle"></div></div>`);
      }
      else if(type == "string")
      {
        $("#workspace").append(`<div id="div_${id}" class="sPosition fCorner"><div id="shape_${id}" class="string"></div></div>`);

      }

      $('#div_' + id).css('height', 150);
      $('#div_' + id).css('width', 150);

      /* Clear other property */
      $(".propertyMenu-2").html(``);

      var property = new ContentProperty();
      property.createShapeProp(id, "#div_" + id, "#shape_" + id, type);

      /* Click each widget event */
      var widgetObject = this.createWidget(id, "div_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#div_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createShapeProp(id, "#div_" + id, "#shape_" + id, type);
      })
        .on('dragmove', function (event) {
          /* Change focus */
          $(".sPosition").removeClass("fCorner");
          $("#div_" + id).addClass("fCorner");

          var target = event.target,
          // keep the dragged position in the data-x/data-y attributes
          x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
          y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
          z = (parseFloat(target.getAttribute('data-z')) || 0);

        // translate the element
        target.style.webkitTransform =
          target.style.transform =
          'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

        // update the posiion attributes
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
        target.setAttribute('data-z', z);

          /* Clear other property */
          $(".propertyMenu-2").html(``);

          var property = new ContentProperty();
          property.createShapeProp(id, "#div_" + id, "#shape_" + id, type);
        })

      /* Save widget */
      let saveObject = new WidgetObject();
      saveObject.WidgetShapeObject(id, null, type);
      widgetObjectList.push(saveObject);
    }

    this.loadShapeWidget = (id, divTag, type) => {
      this.clearfocus();
      console.log(divTag);
      $("#workspace").append(divTag);

      /* Clear other property */
      $(".propertyMenu-2").html(``);
      this.clearfocus();

      /* Click each widget event */
      var widgetObject = this.createWidget(id, "div_");
      widgetObject.on('tap', function (event) {
        /* Change focus */
        $(".sPosition").removeClass("fCorner");
        $("#div_" + id).addClass("fCorner");

        /* Clear other property */
        $(".propertyMenu-2").html(``);

        var property = new ContentProperty();
        property.createShapeProp(id, "#div_" + id, "#shape_" + id, type);
      })
        .on('dragmove', function (event) {
          /* Change focus */
          $(".sPosition").removeClass("fCorner");
          $("#div_" + id).addClass("fCorner");

          var target = event.target,
          // keep the dragged position in the data-x/data-y attributes
          x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx,
          y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy,
          z = (parseFloat(target.getAttribute('data-z')) || 0);

        // translate the element
        target.style.webkitTransform =
          target.style.transform =
          'translate(' + x + 'px, ' + y + 'px) rotate(' + z + 'deg)';

        // update the posiion attributes
        target.setAttribute('data-x', x);
        target.setAttribute('data-y', y);
        target.setAttribute('data-z', z);

          /* Clear other property */
          $(".propertyMenu-2").html(``);

          var property = new ContentProperty();
          property.createShapeProp(id, "#div_" + id, "#shape_" + id, type);
        })

      /* Save widget */
      let saveObject = new WidgetObject();
      saveObject.WidgetShapeObject(id, null, type);
      widgetObjectList.push(saveObject);
    }
  } //Constructor
} //Shape class

class Property {
  constructor() {
    /* Create UI & function property */
    $("#propertySpace").html(`<div class="propertyMenu-2">
                                <div class="propertyMenu-2-context"></div>
                                <div class="propertyMenu-2-paper"></div>
                              </div>`);

    this.createContext = (id, full_id, type, myChart, pathImage) => {
      $(".propertyMenu-2-context").append(`  
            <div class="container">
                <div class="row row-block border-bottom-only">
                    <div class="col-2">
                        <button type="button" id="backest_widget_${id}" class="btn btn-default"><i class="far fa-caret-square-down"></i></button>
                    </div>
                    <div class="col-3">
                        <button type="button" id="topest_widget_${id}"  class="btn btn-default"><i class="far fa-caret-square-up"></i></button>
                    </div>
                    <div class="col-2">
                        <button type="button" id="align_left_widget_${id}" class="btn btn-default"><i class="fas fa-align-left"></i></button>
                    </div>
                    <div class="col-2">
                        <button type="button" id="align_center_widget_${id}" class="btn btn-default"><i class="fas fa-align-center"></i></button>
                    </div>
                    <div class="col-2">         
                        <button type="button" id="align_right_widget_${id}" class="btn btn-default"><i class="fas fa-align-right"></i></button>
                    </div>
                </div>
                <div class="row row-block">
                    <div class="col-9">
                        <button type="button" id="download_widget_${id}" class="btn btn-default form-control">Download</button>
                    </div>
                    <div class="col-2" style="display:none;">
                        <button type="button" id="preview_widget_${id}" class="btn btn-default" ><i class="fas fa-desktop"></i></button>
                    </div>
                    <div class="col-1">
                        <button type="button" id="delete_widget_${id}" class="btn btn-default" ><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            </div>`);
      
      $("#backest_widget_" + id).click(function () {
        $(".sPosition").each(function (index) {
          if ($(this).hasClass("fCorner")) {
            $(this).css("z-index", 0);
          }
          else {
            $(this).css("z-index", index + 1);
          }
        });
      });

      $("#topest_widget_" + id).click(function () {
        $(".sPosition").each(function (index) {
          if ($(this).hasClass("fCorner")) {
            $(this).css("z-index", $(".sPosition").length);
          }
          else {
            $(this).css("z-index", index);
          }
        });
      });

      $("#align_left_widget_" + id).click(function () {
        var transform   = $(full_id).css('transform').split(',');
        var transformY  = transform[5].split(')')[0];

        $(full_id).css('transform', 'translate(0px, ' + transformY + 'px)');
        $(full_id).attr('data-x', 0);
        $(full_id).attr('data-y', transformY);
      });

      $("#align_center_widget_" + id).click(function () {
        var transform   = $(full_id).css('transform').split(',');
        var transformY  = transform[5].split(')')[0];
        var transformX  = (595 / 2) - ($(full_id).width() / 2);

        $(full_id).css('transform', 'translate(' + transformX + 'px, ' + transformY + 'px)');
        $(full_id).attr('data-x', transformX);
        $(full_id).attr('data-y', transformY);
      });

      $("#align_right_widget_" + id).click(function () {
        var transform   = $(full_id).css('transform').split(',');
        var transformY  = transform[5].split(')')[0];
        var transformX  = 595 - $(full_id).width();

        $(full_id).css('transform', 'translate(' + transformX + 'px, ' + transformY + 'px)');
        $(full_id).attr('data-x', transformX);
        $(full_id).attr('data-y', transformY);
      });

      $("#download_widget_" + id).click(function () {
        var transform = $(full_id).css('transform');
        var data_x    = $(full_id).css('data-x');
        var data_y    = $(full_id).css('data-y');
        var width     = $(full_id).css('width');
        var height     = $(full_id).css('height');

        $(full_id).css('transform', 'translate(0px, 0px)');
        $(full_id).css('data-x', 0);
        $(full_id).css('data-y', 0);
        $(full_id).css('width', 1920);
        $(full_id).css('height', 1080);
        $(full_id).removeClass("fCorner");

        $("#modelDownload_" + id).remove();
        var modalDownload = `
        <div class="modal" id="modelDownload_${id}" class="modelcropper">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Download</h4>
                        <button type="button" id="close_download_${id}" class="close" data-dismiss="modal">&times;</button>
                    </div>

                    <div class="modal-body">
                        <div class="row justify-content-center">
                            <div class="col-5 header-line">
                               <span class="header-title">Save as file</span>
                               <div class="row">
                                  <div class="col-6">
                                    <button type="button" id="download_as_pdf_${id}" class="btn btn-default" style="width:inherit;" data-loading-text="<i class='fas fa-circle-notch fa-spin'></i>LOADING..."><i class="far fa-file-pdf" style="margin-right:10px"></i>PDF</button>
                                  </div>
                                  <div class="col-6">
                                    <button type="button" id="download_as_excel_${id}" class="btn btn-default" style="width:inherit;" data-loading-text="<i class='fas fa-circle-notch fa-spin'></i>LOADING..."><i class="fas fa-file-excel" style="margin-right:10px"></i>EXCEL</button>
                                  </div>
                               </div>
                            </div>
                            <div class="col-5 header-line">
                              <span class="header-title">Save as image</span>
                                <div class="row">
                                  <div class="col-6">
                                    <button type="button" id="download_as_png_${id}" class="btn btn-default" style="width:inherit;" data-loading-text="<i class='fas fa-circle-notch fa-spin'></i>LOADING..."><i class="far fa-file-image" style="margin-right:10px"></i>PNG</button>
                                  </div>
                                  <div class="col-6">
                                    <button type="button" id="download_as_jpg_${id}" class="btn btn-default" style="width:inherit;" data-loading-text="<i class='fas fa-circle-notch fa-spin'></i>LOADING..."><i class="far fa-image" style="margin-right:10px"></i>JPG</button>
                                  </div>
                               </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;

        $('body').append(modalDownload);
        $("#modelDownload_" + id).modal('show');

        if(type == "table" || type == "line" || type == "bar" || type == "pie" || type == "radar")
        {
          $('#download_as_excel_' + id).prop('enabled', true);
        }
        else
        {
          $('#download_as_excel_' + id).prop('disabled', true);
        }

        $("#download_as_pdf_" + id).click(function () {
          LOADING.set($("#download_as_pdf_" + id));

          html2canvas(document.querySelector(full_id)).then(canvas => {
            var myLinkImage = canvas.toDataURL("image/png");
            var pdf         = new jsPDF();

            pdf.addImage(myLinkImage, 'JPEG', 0, 0, pdf.internal.pageSize.getWidth(), pdf.internal.pageSize.getHeight());
            pdf.save( infoName + ".pdf");

            LOADING.reset($("#download_as_pdf_" + id));
          });
        });

        $("#download_as_excel_" + id).click(function () {
          LOADING.set($("#download_as_excel_" + id));

          let data = [];

          if(type == "line" || type == "bar")
          {
            myChart.data.datasets.map(_data => {
                _data.data.map(_value => {
                  let dataValue = {};

                  dataValue['Label'] = _data.label;
                  dataValue['Time'] = moment(_value.x).format('YYYY-MM-DD HH:mm:ss');
                  dataValue['Value'] = _value.y;

                  data.push(dataValue);
                });
            });
          }
          else if(type == "table")
          {
            let tab = $("#table_" + id);

            for(let i = 1; i < tab[0].rows[0].cells.length; i++)
            {
              for(let j = 1; j < tab[0].rows.length; j++)
              {
                let dataValue = {};

                dataValue['Label'] = tab[0].rows[0].cells[i].textContent;
                dataValue['Time'] = tab[0].rows[j].cells[0].textContent;
                dataValue['Value'] = tab[0].rows[j].cells[i].textContent;
  
                data.push(dataValue);
              }
            }
          }
          else
          {
            myChart.data.datasets.map(_data => {
              _data.data.map((_value, index) => {
                let dataValue = {};

                dataValue['Label'] = _data.label;
                dataValue['Time'] = myChart.data.labels[index];
                dataValue['Value'] = _value;

                data.push(dataValue);
              });
            });
          }

          try {
            json2excel({
                data,
                name: 'report',
                formateDate: 'yyyy/mm/dd HH:MM:ss'
            });
          } catch (e) {
              console.error('export error');
          }

          LOADING.reset($("#download_as_excel_" + id));
        });
        
        $("#download_as_png_" + id).click(function () {
          LOADING.set($("#download_as_png_" + id));

          html2canvas(document.querySelector(full_id)).then(canvas => {
            var myLinkImage = canvas.toDataURL("image/png");

            var a = document.createElement("a");
            a.href = myLinkImage;
            a.setAttribute("download", infoName + ".png");
            var b = document.createEvent("MouseEvents");
            b.initEvent("click", false, true);
            a.dispatchEvent(b);

            LOADING.reset($("#download_as_png_" + id));
          });
        });

        $("#download_as_jpg_" + id).click(function () {
          LOADING.set($("#download_as_jpg_" + id));

          html2canvas(document.querySelector(full_id)).then(canvas => {
            var myLinkImage = canvas.toDataURL("image/png");

            var a = document.createElement("a");
            a.href = myLinkImage;
            a.setAttribute("download", infoName + ".jpg");
            var b = document.createEvent("MouseEvents");
            b.initEvent("click", false, true);
            a.dispatchEvent(b);

            LOADING.reset($("#download_as_jpg_" + id));
          });
        });

        $('#modelDownload_' + id).on('hidden.bs.modal', function (e) {
          restoreSetting();

          $("#modelDownload_" + id).modal('hide');
          $("#modelDownload_" + id).modal('dispose');
          $("#modelDownload_" + id).remove();
        })

        function restoreSetting()
        {
          $(full_id).css('transform', transform);
          $(full_id).css('data-x', data_x);
          $(full_id).css('data-y', data_y);
          $(full_id).css('width', width);
          $(full_id).css('height', height);
          $(full_id).addClass("fCorner");
        }
      });

      $("#preview_widget_" + id).click(function () {
        var popup = window.open();
        popup.document.write("<h1 id='loading'>Loading...</h1>");

        var transform = $(full_id).css('transform');
        var data_x = $(full_id).css('data-x');
        var data_y = $(full_id).css('data-y');

        $(full_id).css('transform', 'translate(0px, 0px)');
        $(full_id).css('data-x', 0);
        $(full_id).css('data-y', 0);
        $(full_id).removeClass("fCorner");

        html2canvas(document.querySelector(full_id)).then(div => {
          var myImage = div.toDataURL("image/png");

          $(full_id).css('transform', transform);
          $(full_id).css('data-x', data_x);
          $(full_id).css('data-y', data_y);
          $(full_id).addClass("fCorner");

          var img = '<img src="' + myImage + '">';
          popup.document.write(img);
          popup.document.title = "Preview";
          popup.document.getElementById("loading").remove();
        });
      });  
      
      $("#delete_widget_" + id).click(function () {

        if(type == "line" || type == "bar" || type == "pie" || type == "radar")
        {
          let ctx = document.getElementById("div_canvas_" + id);       
          myChart.destroy();
          ctx.remove();
        }
        else if(type == "map")
        {
          let ctx  = document.getElementById("div_map_" + id);
          ctx.remove();
        }
        else if(type == "text")
        {
          let ctx  = document.getElementById("span_" + id);
          ctx.remove();
        }
        else if(type == "table")
        {
          let ctx = document.getElementById("table_" + id);
          ctx.remove();
        }
        else if(type == "image")
        {
          let ctx = document.getElementById("div_" + id);   
          ctx.remove();

          deleteImagePath.push(pathImage);
        }
        else if(type == "square" || type == "circle" || type == "string")
        {
          let ctx  = document.getElementById("div_" + id);
          ctx.remove();
        }
        $(".propertyMenu-2").html(``);

        widgetObjectList  = arrayRemove(widgetObjectList, id);

      });
    }

    this.createEditdata = (id, myChart, full_id, type) => {
      //Set up before edit click
      let model = new viewModelInfographic();
      let mainChart = $('#canvas_' + id);
      let periodType;
      let seriesType = "today";
      let stateMode;
      let classicChart;
      let seriesChart;
      let selectDatasourceList = [];
      let selectDWNameList = [];
      let selectDataList = [];
      let selectDatasourceListSeries = [];
      let selectDWNameListSeries = [];
      let selectDataListSeries = [];
      let apiList = [];
      let apiListSeries = [];
      let dailyLables;
      let monthlyLables;
      let yearlyLables;

      $(".propertyMenu-2-paper").append(`                
          <div class="propertyMenu-2-block">
            <button type="button" id="edit_chart_data_${id}" class="btn btn-default form-control button-width">Edit data</button>     
          </div>`);

      //Edit click
      $("#edit_chart_data_" + id).click(function () {

        selectDatasourceList = [];
        selectDWNameList = [];
        selectDataList = [];
        selectDatasourceListSeries = [];
        selectDWNameListSeries = [];
        selectDataListSeries = [];
        apiList = [];
        apiListSeries = [];

        $("#model_edit_chart_data_" + id).remove();

        $('body').append(model.EditGraphMainModel(id, myChart));
        $("#model_edit_chart_data_" + id).modal('show');

        //Some type not support
        if(type == "pie" || type == "radar")
        {
          $('#btn_series_' + id).prop('disabled', true);
        }

        if(type == "line")
        {
          $("#area_section_classic_" + id).show();
          $("#area_section_series_" + id).show();

          if(mainChart.attr('area-check') == "true")
          {
            $("#area_check_" + mainChart.attr('state-mode') + "_" + id)[0].checked = true;
          }
          else
          {
            $("#area_check_" + mainChart.attr('state-mode') + "_" + id)[0].checked = false;
          }
        }

        $('#select_period_series_' + id).change(function(){

          if($('#select_period_series_' + id).val() == "custom")
          {
            $("#div_custom_" + id + "_series").show();
          }
          else
          {
            $("#div_custom_" + id + "_series").hide();
          }
        });

        $('#btn_classic_' + id).click(function(){
          stateMode = "classic";
          $("#classic_" + id).fadeIn();
          $("#series_" + id).hide();
        });

        $('#btn_series_' + id).click(function(){
          stateMode = "series";
          $("#series_" + id).fadeIn();
          $("#classic_" + id).hide();
        });
      
        //First Set Up
        if(mainChart.attr('state-mode') == "classic")
        {
          $("#btn_classic_" + id).click();

          classicChart = cloneCanvas(myChart, id, type, "classic");
          setButtonPeriod(id , mainChart.attr('period-type'), mainChart.attr('start-value'), mainChart.attr('end-value'));
          setValueClassicChart();
          setDefaultData(classicChart); 

          seriesChart = newSeriesCanvas(id, type, "series");
          setDefaultDataSeries(seriesChart);
        }
        else if(mainChart.attr('state-mode') == "series")
        {
          $("#btn_series_" + id).click();

          seriesChart = cloneCanvas(myChart, id, type, "series");
          
          seriesType = mainChart.attr('series-type');
          $("#select_period_series_" + id).val(seriesType);

          setValueSeriesChart();
          setDefaultDataSeries(seriesChart);

          classicChart = newClassicCanvas(id, type, "classic");
          setButtonPeriod(id , mainChart.attr('period-type'), mainChart.attr('start-value'), mainChart.attr('end-value'));
          setDefaultData(classicChart);
        }

        //Period event
        $("#btn_daily_" + id).click(function () {
          periodType = "daily";
          selectDatasourceList = [];
          selectDWNameList = [];
          selectDataList = [];
          apiList = [];
          dailyLables = [];

          for(let i = 0; i < classicChart.data.datasets.length; i++)
          {
            classicChart.data.datasets[i].data = [];
          }

          classicChart.data.labels = [];
          classicChart.update();

          let ctx  = $("#chart_data_" + id + "_classic");
          ctx.contents().remove();

          setDefaultData(classicChart);
        });

        $("#btn_monthly_" + id).click(function () {
          periodType = "monthly";
          selectDatasourceList = [];
          selectDWNameList = [];
          selectDataList = [];
          apiList = [];
          monthlyLables = [];

          for(let i = 0; i < classicChart.data.datasets.length; i++)
          {
            classicChart.data.datasets[i].data = [];
          }

          classicChart.data.labels = [];
          classicChart.update();

          let ctx  = $("#chart_data_" + id + "_classic");
          ctx.contents().remove();

          setDefaultData(classicChart);
        });

        $("#btn_yearly_" + id).click(function () {
          periodType = "yearly";
          selectDatasourceList = [];
          selectDWNameList = [];
          selectDataList = [];
          apiList = [];
          yearlyLables = [];

          for(let i = 0; i < classicChart.data.datasets.length; i++)
          {
            classicChart.data.datasets[i].data = [];
          }

          classicChart.data.labels = [];
          classicChart.update();

          let ctx  = $("#chart_data_" + id + "_classic");
          ctx.contents().remove();

          setDefaultData(classicChart);
        });

        $("#start_daily_" + id).change(function () {
          if($("#start_daily_" + id).val() != "" && $("#end_daily_" + id).val() != ""){
            $("#btn_daily_" + id).click();
          }
        });

        $("#end_daily_" + id).change(function () {
           if($("#start_daily_" + id).val() != "" && $("#end_daily_" + id).val() != ""){
            $("#btn_daily_" + id).click();
          }
        });

        $("#start_monthly_" + id).change(function () {
          if($("#start_monthly_" + id).val() != "" && $("#end_monthly_" + id).val() != ""){
            $("#btn_monthly_" + id).click();
          }
        });

        $("#end_monthly_" + id).change(function () {
          if($("#start_monthly_" + id).val() != "" && $("#end_monthly_" + id).val() != ""){
            $("#btn_monthly_" + id).click();
          }
        });

        $("#start_yearly_" + id).change(function () {
          if($("#start_yearly_" + id).val() != "" && $("#end_yearly_" + id).val() != ""){
            $("#btn_yearly_" + id).click();
          }
        });

        $("#end_yearly_" + id).change(function () {
          if($("#start_yearly_" + id).val() != "" && $("#end_yearly_" + id).val() != ""){
            $("#btn_yearly_" + id).click();
          }
        });

        $("#select_period_series_" + id).change(function () {
          if($(this).val() != 0)
          {
            seriesType = $(this).val();

            let ctx  = $("#chart_data_" + id + "_series");
            ctx.contents().remove();

            setDefaultDataSeries(seriesChart);
          }
        });

        //Label event
        $("#x_label_classic_" + id).keyup(function () {
          classicChart.options.scales.xAxes[0].scaleLabel.labelString = $("#x_label_classic_" + id).val();
          classicChart.update();
        });

        $("#y_label_classic_" + id).keyup(function () {
          classicChart.options.scales.yAxes[0].scaleLabel.labelString = $("#y_label_classic_" + id).val();
          classicChart.update();
        });

        $("#x_label_series_" + id).keyup(function () {
          seriesChart.options.scales.xAxes[0].scaleLabel.labelString = $("#x_label_series_" + id).val();
          seriesChart.update();
        });

        $("#y_label_series_" + id).keyup(function () {
          seriesChart.options.scales.yAxes[0].scaleLabel.labelString = $("#y_label_series_" + id).val();
          seriesChart.update();
        });

        //Add button event
        $("#add_new_data_" + id + "_classic").click(function () {

          let newData;

          if(type == "bar" || type == "pie")
          {
            newData =
            {
              label: "New data",
              data: [],
              backgroundColor: '#343a40'
            };
          }
          else
          {
            newData =
            {
              label: "New data",
              data: [],
              backgroundColor: 'rgba(255, 255, 255, 0)',
              borderColor:'#343a40'
            };
          }
  
          classicChart.data.datasets.push(newData);
          classicChart.update();

          if(type == "line")
          {
            $("#area_check_classic_" + id).change();
          }

          let ctx  = $("#chart_data_" + id + "_classic");
          ctx.contents().remove();

          selectDatasourceList.push(0);
          selectDWNameList.push(0);
          selectDataList.push("");

          setDefaultData(classicChart);
        });

        $("#add_new_data_" + id + "_series").click(function () {

          let newData;

          if(type == "bar" || type == "pie")
          {
            newData =
            {
              label: "New data",
              data: [],
              backgroundColor: '#343a40'
            };
          }
          else
          {
            newData =
            {
              label: "New data",
              data: [],
              backgroundColor: 'rgba(255, 255, 255, 0)',
              borderColor:'#343a40'
            };
          }
  
          seriesChart.data.datasets.push(newData);
          seriesChart.update();

          if(type == "line")
          {
            $("#area_check_series_" + id).change();
          }

          let ctx  = $("#chart_data_" + id + "_series");
          ctx.contents().remove();

          selectDatasourceListSeries.push(0);
          selectDWNameListSeries.push(0);
          selectDataListSeries.push("");

          setDefaultDataSeries(seriesChart);
        });

        //Save event
        $("#save_chart_data_" + id).click(function () {

          mainChart.attr('state-mode', stateMode);

          if(stateMode == "classic")
          {
            addOptions(myChart, classicChart.options);
            addLabel(myChart, classicChart.data.labels);
            addDatasets(myChart, classicChart.data.datasets);

            mainChart.attr("maiden-check", "false");
            mainChart.attr("area-check", $("#area_check_classic_" + id)[0].checked);

            mainChart.attr('period-type', periodType);
            mainChart.attr('start-value', $("#start_" + periodType + "_" + id).val());
            mainChart.attr('end-value', $("#end_" + periodType + "_" + id).val());

            mainChart.attr('select-datasource-list', selectDatasourceList);
            mainChart.attr('select-dwname-list', selectDWNameList);
            mainChart.attr('select-keydata-list', selectDataList);

            mainChart.removeAttr("series-type");
            mainChart.removeAttr("select-datasource-list-series");
            mainChart.removeAttr('select-dwname-list-series');
            mainChart.removeAttr("select-keydata-list-series");
          }
          else if(stateMode == "series")
          {
            addOptions(myChart, seriesChart.options);
            addLabel(myChart, seriesChart.data.labels);
            addDatasets(myChart, seriesChart.data.datasets);

            mainChart.attr("maiden-check", "false");
            mainChart.attr("area-check", $("#area_check_series_" + id)[0].checked);

            mainChart.attr("series-type", seriesType);

            mainChart.attr('select-datasource-list-series', selectDatasourceListSeries);
            mainChart.attr('select-dwname-list-series', selectDWNameListSeries);
            mainChart.attr('select-keydata-list-series', selectDataListSeries);

            mainChart.removeAttr('period-type');
            mainChart.removeAttr('start-value');
            mainChart.removeAttr('end-value');

            mainChart.removeAttr('select-datasource-list');
            mainChart.removeAttr('select-dwname-list');
            mainChart.removeAttr('select-keydata-list');

          }

          mainChart.data("graph", myChart);

          $(".propertyMenu-2").html(``);

          var property = new ContentProperty();
          property.createGraphProp(id, myChart, "#div_canvas_" + id, type);

          $("#model_edit_chart_data_" + id).modal('hide');
        });

        //Option event
        $("#model_edit_chart_data_" + id).on("hidden.bs.modal", function () {

          if(mainChart.attr("maiden-check") == "wait")
          {
            mainChart.attr("maiden-check", "true");
          }
        });

        $('#area_check_classic_' + id).change(function(){
          if(this.checked) {
            for(let i = 0; i < classicChart.data.datasets.length; i++)
            {
              classicChart.data.datasets[i].backgroundColor = convertHex(classicChart.data.datasets[i].borderColor, 20);
            }
            classicChart.update();
          }
          else
          {
            for(let i = 0; i < classicChart.data.datasets.length; i++)
            {
              classicChart.data.datasets[i].backgroundColor = 'rgba(255, 255, 255, 0)';
            }
            classicChart.update();
          }
        });

        $('#area_check_series_' + id).change(function(){
          if(this.checked) {
            for(let i = 0; i < seriesChart.data.datasets.length; i++)
            {
              seriesChart.data.datasets[i].backgroundColor = convertHex(seriesChart.data.datasets[i].borderColor, 20);
            }
            seriesChart.update();
          }
          else
          {
            for(let i = 0; i < seriesChart.data.datasets.length; i++)
            {
              seriesChart.data.datasets[i].backgroundColor = 'rgba(255, 255, 255, 0)';
            }
            seriesChart.update();
          }
        });

      });

      //Function section
      //Chart clone section
      function cloneCanvas(myChart, id, type, stateType)
      {
        let ctx = document.getElementById("preview_canvas_" + id + "_" + stateType);
        
        let myChart2 = new Chart(ctx, {
          type: type,
          options: myChart.options
        });

        addLabel(myChart2, myChart.data.labels);
        addDatasets(myChart2, myChart.data.datasets);

        return myChart2;
      }

      function addLabel(chart, labels)
      {
        chart.data.labels = [];
        for (let i = 0; i < labels.length; i++) {
          chart.data.labels.push(labels[i]);
        }
        chart.update();
      }
  
      function addDatasets(chart, dataSets)
      {
        chart.data.datasets = [];
        for (let i = 0; i < dataSets.length; i++) {
          var newData =
          {
            label: dataSets[i].label,
            data: dataSets[i].data,
            backgroundColor: dataSets[i].backgroundColor,
            borderColor: dataSets[i].borderColor
          };
  
          chart.data.datasets.push(newData);
        }
        chart.update();
      }

      function addOptions(chart, option)
      {
        chart.options = option;
        chart.update();
      }

      //Chart new create section
      function newClassicCanvas(id, type, stateType)
      {
        let ctx = document.getElementById("preview_canvas_" + id + "_" + stateType);

        let demoData;
        let chartOptions;

        if(type == "line")
        {
          demoData = 
          {
            datasets: [
              {
                label:'Demo Data 1',
                data: [
                  {x: new Date('2000','02','20'), y:25},
                  {x: new Date('2001','02','21'), y:50},
                  {x: new Date('2002','02','22'), y:75},
                  {x: new Date('2003','02','23'), y:100}],
                  backgroundColor: 'rgba(255, 255, 255, 0)',
                  borderColor: '#05acd3'
              }, 
              {
                label:'Demo Data 2',
                data: [
                  {x: new Date('2002','04','10'), y:10},
                  {x: new Date('2003','04','11'), y:20},
                  {x: new Date('2004','04','12'), y:30},
                  {x: new Date('2005','04','13'), y:40}],
                  backgroundColor: 'rgba(255, 255, 255, 0)',
                  borderColor: '#00ce68'
              }]
          };
        }
        else if(type == "bar")
        {
          demoData = 
          {
            datasets: [
              {
                label:'Demo Data 1',
                data: [
                  {x: new Date('2000','02','20'), y:25},
                  {x: new Date('2001','02','21'), y:50},
                  {x: new Date('2002','02','22'), y:75},
                  {x: new Date('2003','02','23'), y:100}],
                  backgroundColor: '#05acd3',
              }, 
              {
                label:'Demo Data 2',
                data: [
                  {x: new Date('2002','04','10'), y:10},
                  {x: new Date('2003','04','11'), y:20},
                  {x: new Date('2004','04','12'), y:30},
                  {x: new Date('2005','04','13'), y:40}],
                  backgroundColor: '#00ce68',
              }]
          };
        }
        else if(type == "pie")
        {
          demoData = {
            labels: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
            datasets: [{
              label: "Demo Data 1",
              data: [0, 59, 75, 20, 20, 55, 40],
              backgroundColor: '#05acd3'
            }, {
              label: "Demo Data 2",
              data: [0, 29, 25, 20, 20, 25, 20],
              backgroundColor: '#00ce68'
            }]
          };
        }
        else if(type == "radar")
        {
          demoData = {
            labels: ["Su", "Mo", "Tu", "We", "Th", "Fr", "Sa"],
            datasets: [{
              label: "Demo Data 1",
              data: [0, 59, 75, 20, 20, 55, 40],
              backgroundColor: 'rgba(255, 255, 255, 0)',
              borderColor: '#05acd3'
            }, {
              label: "Demo Data 2",
              data: [0, 29, 25, 20, 20, 25, 20],
              backgroundColor: 'rgba(255, 255, 255, 0)',
              borderColor: '#00ce68'
            }]
          };
        }

        if(type == "line" || type == "bar")
        {
          chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            legend: {
              display: true,
              position: 'top',
              labels: {
                boxWidth: 80,
                fontColor: 'black'
              }
            },
            scales: {
                xAxes: [{
                    type: 'time',
                    distribution: 'linear',
                    ticks:{
                      source:'auto'
                    },
                    scaleLabel: {
                      display: true,
                      labelString: 'X Label'
                    }
                }],
                yAxes: [{
                  scaleLabel: {
                    display: true,
                    labelString: 'Y Label'
                  }
                }],
            },
            zoom: {
              enabled: true,
              drag: false,
              mode: "x",
              limits: {
                max: 12,
                min: 5
              }
            }
          };  
        }
        else
        {
          chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            legend: {
              display: true,
              position: 'top',
              labels: {
                boxWidth: 80,
                fontColor: 'black'
              }
            },
            scales: {
              yAxes: [{
                scaleLabel: {
                  display: true,
                  labelString: 'Y Label'
                }
              }],
              xAxes: [{
                scaleLabel: {
                  display: true,
                  labelString: 'X Label'
                }
              }],
            }
          };
        }
  
        let myChart2 = new Chart(ctx, {
          type: type,
          data: demoData,
          options: chartOptions
        });

        return myChart2;
      }

      function newSeriesCanvas(id, type, stateType)
      {
        let ctx = document.getElementById("preview_canvas_" + id + "_" + stateType);

        let demoData;

        if(type == "bar" || type == "pie")
        {
          demoData = {
            datasets: [{
              label: "Demo Data",
              data: [
                { x: new Date(2017,5,11), y: 100 },
                { x: new Date(2019,2,21), y: 50 },],
              backgroundColor: '#05acd3'
            }]
          };
        }
        else
        {
          demoData = {
            datasets: [{
              label: "Demo Data",
              data: [
                { x: new Date(2017,5,11), y: 100 },
                { x: new Date(2019,2,21), y: 50 },],
              backgroundColor: 'rgba(255, 255, 255, 0)',
              borderColor:'#05acd3'
            }]
          };
        }
  
        let chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          legend: {
            display: true,
            position: 'top',
            labels: {
              boxWidth: 80,
              fontColor: 'black'
            }
          },
          scales: {
              xAxes: [{
                  type: 'time',
                  distribution: 'linear',
                  ticks:{
                    source:'auto'
                  },
                  scaleLabel: {
                    display: true,
                    labelString: 'X Label'
                  }
              }],
              yAxes: [{
                scaleLabel: {
                  display: true,
                  labelString: 'Y Label'
                }
              }],
          },
          zoom: {
            enabled: true,
            drag: false,
            mode: "x",
            limits: {
              max: 12,
              min: 5
            }
          }
        };

        let myChart2 = new Chart(ctx, {
          type: type,
          data: demoData,
          options: chartOptions
        });

        return myChart2;
      }

      //Set up value section
      function setButtonPeriod(id, period_type, startValue, endValue)
      {
        if(period_type == "daily")
        {
          periodType = "daily";

          $("#btn_daily_" + id).addClass("active show");
          $("#daily_" + id).addClass("active show");

          $("#start_daily_" + id).val(startValue);
          $("#end_daily_" + id).val(endValue);

          dailyLables = myChart.data.labels;
        }
        else if(period_type == "monthly")
        {
          periodType = "monthly";

          $("#btn_monthly_" + id).addClass("active show");
          $("#monthly_" + id).addClass("active show");

          $("#start_monthly_" + id).val(startValue);
          $("#end_monthly_" + id).val(endValue);

          monthlyLables = myChart.data.labels;
        }
        else if(period_type == "yearly")
        {
          periodType = "yearly";

          $("#btn_yearly_" + id).addClass("active show");
          $("#yearly_" + id).addClass("active show");

          $("#start_yearly_" + id).val(startValue);
          $("#end_yearly_" + id).val(endValue);

          yearlyLables = myChart.data.labels;
        }
        else
        {
          periodType = "daily";
          $("#btn_daily_" + id).addClass("active show");
          $("#daily_" + id).addClass("active show");
        }
      }

      function setValueClassicChart()
      {
        for(var k = 0; k < classicChart.data.datasets.length; k++)
        {     
          if(mainChart.attr('select-datasource-list') != null)
          {
            selectDatasourceList.push(mainChart.attr('select-datasource-list').split(',')[k]);
            selectDWNameList.push(mainChart.attr('select-dwname-list').split(','[k]));
          }
          else
          {
            selectDatasourceList.push(0);
            selectDWNameList.push(0);
          }

          if(mainChart.attr('select-keydata-list') != null)
          {
            selectDataList.push(mainChart.attr('select-keydata-list').split(',')[k]);
          }
          else
          {
            selectDataList.push("");
          }
        }
      }

      function setValueSeriesChart()
      {
        for(var k = 0; k < seriesChart.data.datasets.length; k++)
        {
        
          if(mainChart.attr('select-datasource-list-series') != null)
          {
            selectDatasourceListSeries.push(mainChart.attr('select-datasource-list-series').split(',')[k]);
            selectDWNameListSeries.push(mainChart.attr('select-dwname-list-series').split(',')[k]);
          }
          else
          {
            selectDatasourceListSeries.push(0);
            selectDWNameListSeries.push(0);
          }

          if(mainChart.attr('select-keydata-list-series') != null)
          {
            selectDataListSeries.push(mainChart.attr('select-keydata-list-series').split(',')[k]);
          }
          else
          {
            selectDataListSeries.push("");
          }
        }
      }

      //Setting value chart section
      function setDefaultData(chart)
      {
        let colorChart;

        for(var i = 0; i < chart.data.datasets.length; i++)
        {
          if(type == "bar" || type == "pie")
          {
            colorChart = chart.data.datasets[i].backgroundColor;
          }
          else
          {
            colorChart = chart.data.datasets[i].borderColor;
          }
  
          $("#chart_data_" + id + "_classic").append(model.DataClassicGraphModel(id, i, colorChart, chart));

          $("#label_preview_chart_" + id + "_" + i).keyup(labelPreviewChartUpdate(chart, i));
          $("#color_preview_chart_" + id + "_" + i).change(colorPreviewChartUpdate(chart, i));
          $("#delete_preview_chart_" + id + "_" + i).click(deletePreviewChartUpdate(chart, i));

          $("#select_datasource_list_" + id + "_" + i).change(datasourceValueUpdate(chart, i));
          $("#id_keydata_list_" + id + "_" + i).change(datalistKeyValueUpdata(chart, i));

          $("#delete_preview_chart_" + id + "_0").remove();
        }

        $.ajax({
          url: END_POINT + 'infographic/getServiceByTypeUser',
          method: 'GET',
          data: {
            type_user: type_user,
          },
          success: (res, textStatus, xhr) => {
            checkAuthRes(xhr);
            listInfoDatasource = res.data;
            console.log(listInfoDatasource);
            let index = 0;

            listInfoDatasource.iotservice.map((data) => {
              $("optgroup[name='opt_iot']").append(`<option value="iot_${data.iotservice_id}_${data.company_id}" keydw="IoT.Input.nut_test2.11">${data.iot_name}</option>`);
              index++;
            });

            listInfoDatasource.webservice.map((data) => {
              $("optgroup[name='opt_web']").append(`<option value="web_${data.webservice_id}_${data.company_id}" keydw="IoT.Input.nut_test2.11">${data.service_name}</option>`);
              index++;
            });

            for(let j = 0; j < selectDatasourceList.length; j++)
            {
              $("#select_datasource_list_" + id + "_" + j).val(selectDatasourceList[j]);
              $("#select_datasource_list_" + id + "_" + j).change();

              $("#id_keydata_list_" + id + "_" + j).val(selectDataList[j]);
              $("#id_keydata_list_" + id + "_" + j).change();
            }

          },
          error: (res) => {
              console.log(res);
          }
        });
      }

      function setDefaultDataSeries(chart)
      {     
        let colorChart;

        for(var i = 0; i < chart.data.datasets.length; i++)
        {
          if(type == "bar" || type == "pie")
          {
            colorChart = chart.data.datasets[i].backgroundColor;
          }
          else
          {
            colorChart = chart.data.datasets[i].borderColor;
          }
  
          $("#chart_data_" + id + "_series").append(model.DataSeriesGraphModel(id, i, colorChart, chart));

          $("#label_preview_chart_" + id + "_" + i + "_series").keyup(labelPreviewChartUpdate(chart, i));
          $("#color_preview_chart_" + id + "_" + i + "_series").change(colorPreviewChartUpdate(chart, i));
          $("#delete_preview_chart_" + id + "_" + i + "_series").click(deletePreviewChartUpdate(chart, i));

          $("#select_datasource_list_" + id + "_" + i + "_series").change(datasourceValueUpdate(chart, i));
          $("#id_keydata_list_" + id + "_" + i + "_series").change(datalistKeyValueUpdata(chart, i));

          $("#delete_preview_chart_" + id + "_0" + "_series").remove();
        }
        
        $.ajax({
          url: END_POINT + 'infographic/getServiceByTypeUser',
          method: 'GET',
          data: {
            type_user: type_user,
          },
          success: (res, textStatus, xhr) => {
            checkAuthRes(xhr);
            listInfoDatasource = res.data;
            
            let index = 0;
            console.log(listInfoDatasource);
            listInfoDatasource.iotservice.map((data) => {
              $("optgroup[name='opt_iot_series']").append(`<option value="iot_${data.iotservice_id}_${data.company_id}" keydw="${data.iot_name_DW}">${data.iot_name}</option>`);
              index++;
            });

            listInfoDatasource.webservice.map((data) => {
              $("optgroup[name='opt_web_series']").append(`<option value="web_${data.webservice_id}_${data.company_id}" keydw="${data.service_name_DW}">${data.service_name}</option>`);
              index++;
            });

            $("#select_period_series_" + id).val(seriesType);
            
            for(var j = 0; j < selectDatasourceListSeries.length; j++)
            {
              $("#select_datasource_list_" + id + "_" + j + "_series").val(selectDatasourceListSeries[j]);    
              $("#select_datasource_list_" + id + "_" + j + "_series").change();

              $("#id_keydata_list_" + id + "_" + j + "_series").val(selectDataListSeries[j]);
              $("#id_keydata_list_" + id + "_" + j + "_series").change();
            }

          },
          error: (res) => {
              console.log(res);
          }
        });
      }

      //Event updata chart data
      function datasourceValueUpdate(chart, index)
      {
        return function()
        {
          if(stateMode == "series")
          {
            let selectValue = $("#select_datasource_list_" + id + "_" + index + "_series").val();
            let timeseries = $("#select_period_series_" + id).val();
            let tableDW = $("select#select_datasource_list_" + id + "_" + index + "_series option:selected").attr('keydw');

            if(selectValue != 0 && timeseries != 0)
            {
              $("#datalist_keydata_list_" + id + "_" + index + "_series").html(`<option value=""></option>`);
              $("#id_keydata_list_" + id + "_" + index + "_series").val("");     
              chart.data.datasets[index].data = [];
              chart.update();

              let today = new Date();
              let startDate = null;
              let endDate = null;
              
              //Demo test ISUS
              if(timeseries == "today")
              {
                endDate = moment(today).endOf('day').format('YYYY-MM-DD HH:mm:ss');
                startDate = moment(today).startOf('day').format('YYYY-MM-DD HH:mm:ss');
              }
              else if(timeseries == "yesterday")
              {
                let yesterday = moment(today).subtract(1, 'days').format('YYYY-MM-DD');
                endDate = moment(yesterday).endOf('day').format('YYYY-MM-DD HH:mm:ss');
                startDate = moment(yesterday).startOf('day').format('YYYY-MM-DD HH:mm:ss');
              }
              else if(timeseries == "current_week")
              {
                startDate = moment(today).startOf('week').format('YYYY-MM-DD HH:mm:ss');
                endDate = moment(today).endOf('week').format('YYYY-MM-DD HH:mm:ss');
              }
              else if(timeseries == "1_week_later")
              {
                startDate = moment(today).subtract(7, 'days').format('YYYY-MM-DD HH:mm:ss');
                endDate = moment(today).format('YYYY-MM-DD HH:mm:ss');
              }
              else if(timeseries == "2_week_later")
              {
                startDate = moment(today).subtract(14, 'days').format('YYYY-MM-DD HH:mm:ss');
                endDate = moment(today).format('YYYY-MM-DD HH:mm:ss');
              }
              else if(timeseries == "4_week_later")
              {
                startDate = moment(today).subtract(28, 'days').format('YYYY-MM-DD HH:mm:ss');
                endDate = moment(today).format('YYYY-MM-DD HH:mm:ss');
              }
              else if(timeseries == "current_month")
              {
                startDate = moment(today).startOf('month').format('YYYY-MM-DD HH:mm:ss');
                endDate = moment(today).endOf('month').format('YYYY-MM-DD HH:mm:ss');
              }
              else if(timeseries == "last_month")
              {
                startDate = moment(today).subtract(1, 'months').startOf('month').format('YYYY-MM-DD  HH:mm:ss');
                endDate = moment(today).subtract(1, 'months').endOf('month').format('YYYY-MM-DD  HH:mm:ss');
              }
              else if(timeseries == "3_month_later")
              {
                startDate = moment(today).subtract(90, 'days').format('YYYY-MM-DD');
                endDate = moment(today).format('YYYY-MM-DD HH:mm:ss');
              }
              else if(timeseries == "6_month_later")
              {
                startDate = moment(today).subtract(180, 'days').format('YYYY-MM-DD');
                endDate = moment(today).format('YYYY-MM-DD HH:mm:ss');
              }
              else if(timeseries == "12_month_later")
              {
                startDate = moment(today).subtract(360, 'days').format('YYYY-MM-DD');
                endDate = moment(today).format('YYYY-MM-DD HH:mm:ss');
              } 

              $.ajax({
                url: API_DW + 'iotService/getInputIoTData_Time',
                method: 'POST',
                async:false,
                data: {
                  tableDW_name: tableDW,
                  start_date: startDate,
                  end_date: endDate
                },
                success: (res, textStatus, xhr) => {
                  checkAuthRes(xhr);
                  console.log(res);
                  apiListSeries[index] = res;

                  let keyValueList = getFlatObject(apiListSeries[index][0]);

                  for(var key in keyValueList)
                  {
                    if(key != "_id" && key != "sumDate" && key != "sumTime" && key != "newDate")
                    {
                      $("#datalist_keydata_list_" + id + "_" + index + "_series").append(`<option value="${key}"></option>`);
                    }
                  }

                  $("#id_keydata_list_" + id + "_" + index + "_series").val("");

                  if(mainChart.attr("maiden-check") == "true")
                  {
                    for(let i = 0; i < chart.data.datasets.length; i++)
                    {
                      chart.data.datasets[i].data = [];
                    }
                    chart.data.labels = [];

                    mainChart.attr("maiden-check", "wait");
                  }
                },
                error: (res) => {
                    console.log(res);
                }
              });
            }
            else
            {
              $("#datalist_keydata_list_" + id + "_" + index + "_series").html(`<option value=""></option>`);
              $("#id_keydata_list_" + id + "_" + index + "_series").val("");
              chart.data.datasets[index].data = [];
              chart.update();
            }
  
            selectDatasourceListSeries[index] = selectValue;
            selectDWNameListSeries[index] = tableDW;
          }
          else if(stateMode == "classic")
          {
            let selectValue = $("#select_datasource_list_" + id + "_" + index).val();
            let tableDW = $("select#select_datasource_list_" + id + "_" + index + " option:selected").attr('keydw');

            if(selectValue != 0)
            {
              $("#datalist_keydata_list_" + id + "_" + index).html(`<option value=""></option>`);
              $("#id_keydata_list_" + id + "_" + index).val("");          
              chart.data.datasets[index].data = [];
              chart.update();

              //Demo test ISUS
              let check = checkDateValue(periodType, id);

              if(check == true)
              {
                let apiType = checkPeriod(periodType);
                let startDate = moment($("#start_" + periodType + "_" + id).val()).format('YYYY-MM-DD HH:mm:ss');
                let endDate = moment($("#end_" + periodType + "_" + id).val()).format('YYYY-MM-DD HH:mm:ss');

                $.ajax({
                  url: API_DW + 'iotService/getInputAggregationForWeb',
                  async:false,
                  method: 'POST',
                  data: {
                    type: apiType,
                    nameDW: tableDW,
                    end_date: endDate,
                    start_date: startDate
                  },
                  success: (res, textStatus, xhr) => {
                    checkAuthRes(xhr);

                    console.log(res);

                    apiList[index] = res;

                    let keyValueList = getFlatObject(apiList[index][0]);

                    for(var key in keyValueList)
                    {
                      if(key != "_id" && key != "DayOfWeek" && key != "real_date" && key != "create_date")
                      {
                        $("#datalist_keydata_list_" + id + "_" + index).append(`<option value="${key}"></option>`);
                      }
                    }

                    $("#id_keydata_list_" + id + "_" + index).val("");

                    if(mainChart.attr("maiden-check") == "true")
                    {
                      for(let i = 0; i < chart.data.datasets.length; i++)
                      {
                        chart.data.datasets[i].data = [];
                      }
                      chart.data.labels = [];

                      mainChart.attr("maiden-check", "wait");
                    }

                    if(type == "pie" || type == "radar")
                    {
                      let check = 0;
                      let dateString;

                      for(let i = 0; i < apiList[index].length; i++)
                      {
                        dateString = moment(apiList[index][i]["real_date"]).format('YYYY-MM-DD').toString();

                        for(let j = 0; j < chart.data.labels.length; j++)
                        {
                          if(dateString == chart.data.labels[j])
                          {
                            check = 1;
                            break;
                          }
                        }

                        if(check != 1)
                        {
                          chart.data.labels.push(dateString);
                          chart.update();
                        }

                        check = 0;
                      }
                    }
                  },
                  error: (res) => {
                    console.log(res);
                  }
                });
              }
            }
            else
            {
              $("#datalist_keydata_list_" + id + "_" + index).html(`<option value=""></option>`);
              $("#id_keydata_list_" + id + "_" + index).val("");
              chart.data.datasets[index].data = [];
              chart.update();
            }
  
            selectDatasourceList[index] = selectValue;
            selectDWNameList[index] = tableDW;
          }
        };
      }

      function datalistKeyValueUpdata(chart, index)
      {
        return function()
        {
          if(stateMode == "series")
          {
            let selectKeyValue = $("#id_keydata_list_" + id + "_" + index + "_series").val();

            if(selectKeyValue != "" && apiListSeries[index] != null)
            {
              let checkInput = false;
              let keyValueList = getFlatObject(apiListSeries[index][0]);

              for(var key in keyValueList)
              {
                if(key == selectKeyValue)
                {
                  checkInput = true;
                  break;
                }
              }

              if(checkInput == true)
              {
                chart.data.datasets[index].data = [];

                for(let i = 0; i < apiListSeries[index].length; i++)
                {
                  let t = {x: apiListSeries[index][i].newDate, y: objectPath.get(apiListSeries[index][i], selectKeyValue)};
                  chart.data.datasets[index].data.push(t);
                }

                chart.update();

                selectDataListSeries[index] = selectKeyValue;
              }
            }
  
          }
          else if(stateMode == "classic")
          {
            let selectKeyValue = $("#id_keydata_list_" + id + "_" + index).val();

            if(selectKeyValue != "" && apiList[index] != null)
            {
              let checkInput = false;
              let keyValueList = getFlatObject(apiList[index][0]);

              for(var key in keyValueList)
              {
                if(key == selectKeyValue)
                {
                  checkInput = true;
                  break;
                }
              }

              if(checkInput == true)
              {
                if(type == "pie" || type == "radar")
                {
                  for(let i = 0; i < apiList[index].length; i++)
                  {
                    for(let j = 0; j < chart.data.labels.length; j++)
                    {
                      let dateApi = moment(apiList[index][i]["real_date"]).format('YYYY-MM-DD').toString();

                      if(chart.data.labels[j] == dateApi)
                      {
                        chart.data.datasets[index].data[j] = objectPath.get(apiList[index][i], selectKeyValue);
                        break;
                      }
                    }
                  }
                }
                else
                {
                  chart.data.datasets[index].data = [];

                  for(let i = 0; i < apiList[index].length; i++)
                  {
                    let dateApi = apiList[index][i]["real_date"];

                    let t = {x: dateApi, y: objectPath.get(apiList[index][i], selectKeyValue)};
                    chart.data.datasets[index].data.push(t);
                  }
                }
              }
            
              chart.update();

              selectDataList[index] = selectKeyValue;
            }
          }
        };
      }

      function colorPreviewChartUpdate(chart, index)
      {
        return function()
        {
          if(type == "bar" || type == "pie")
          {
            if(stateMode == "series")
            {
              chart.data.datasets[index].backgroundColor =  $("#color_preview_chart_" + id + "_" + index + "_series").val();
            }
            else
            {
              chart.data.datasets[index].backgroundColor =  $("#color_preview_chart_" + id + "_" + index).val();
            }  
          }
          else
          {
            if(stateMode == "series")
            {
              chart.data.datasets[index].borderColor =  $("#color_preview_chart_" + id + "_" + index + "_series").val();
            }
            else
            {
              chart.data.datasets[index].borderColor =  $("#color_preview_chart_" + id + "_" + index).val();
            }

            if(type == "line")
            {
              $("#area_check_" + stateMode + "_" + id).change();
            }
          }

          chart.update();
        };
      }

      function labelPreviewChartUpdate(chart, index)
      {
        return function()
        {
          if(stateMode == "series")
          {
            chart.data.datasets[index].label =  $("#label_preview_chart_" + id + "_" + index + "_series").val();
            chart.update();
          }
          else
          {
            chart.data.datasets[index].label =  $("#label_preview_chart_" + id + "_" + index).val();
            chart.update();
          }

        };
      }

      function deletePreviewChartUpdate(chart, index)
      {
        return function()
        {
          if(stateMode == "series")
          {
            chart.data.datasets.splice(index, 1);
            chart.update();

            let ctx  = $("#chart_data_" + id + "_series");
            ctx.contents().remove();

            selectDatasourceListSeries.splice(index, 1);
            selectDWNameListSeries.splice(index, 1);
            selectDataListSeries.splice(index, 1);

            setDefaultDataSeries(chart);
          }
          else
          {
            chart.data.datasets.splice(index, 1);
            chart.update();

            let ctx  = $("#chart_data_" + id + "_classic");
            ctx.contents().remove();

            selectDatasourceList.splice(index, 1);
            selectDWNameList.splice(index, 1);
            selectDataList.splice(index, 1);

            setDefaultData(chart);
          }
        };
      }

      function checkDateValue(period_type, id)
      {
        let check = false;

        if(period_type == "daily")
        {
          if($("#start_daily_" + id).val() != "" && $("#end_daily_" + id).val() != "")
          {
            check = true;
          }
        }
        else if(period_type == "monthly")
        {
          if($("#start_monthly_" + id).val() != "" && $("#end_monthly_" + id).val() != "")
          {
            check = true;
          }
        }
        else if(period_type == "yearly")
        {
          if($("#start_yearly_" + id).val() != "" && $("#end_yearly_" + id).val() != "")
          {
            check = true;
          }
        }

        return check;
      }
      //End section
    }

    this.createCropImage = (id, full_id, full_id_image) => {
      let cropObject;

      $(".propertyMenu-2-paper").append(`                
          <div class="propertyMenu-2-block">
            <button type="button" id="crop_image_widget_${id}" class="btn btn-default form-control button-width">Crop image</button>     
          </div>`);

      $("#crop_image_widget_" + id).click(function () {
        $("#modelCrop_" + id).remove();
        var modalCrop = `
        <div class="modal" id="modelCrop_${id}" class="modelcropper">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title">Crop image</h4>
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                    </div>

                    <div class="modal-body">
                        <div class="row">
                            <div class="col-11 text-center">
                                <img id="image_crop_${id}" style="max-width: 100%; max-height:50%;" />
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" id="save_image_crop_${id}" class="btn btn-success">Save</button>
                    </div>
                </div>
            </div>
        </div>`;

        $('body').append(modalCrop);
        $("#modelCrop_" + id).modal('show');
        $("#image_crop_" + id).attr("src", $(full_id_image).attr("src"));
        let image = document.getElementById('image_crop_' + id);
        cropObject = new Cropper(image, {});

        $("#save_image_crop_" + id).click(function () {
          $(full_id_image).attr("src", cropObject.getCroppedCanvas({width: 500, height: 500}).toDataURL());
          cropObject.destroy();
          $("#modelCrop_" + id).modal('hide');
          $("#modelCrop_" + id).modal('dispose');
          $("#modelCrop_" + id).remove();
        });
      });
    }

    this.createTextchange = (id, full_id) => {
      $(".propertyMenu-2-paper").append(`                      
          <div class="propertyMenu-2-block">
            <div class="container">
                <div class="row row-block">
                    <span>Text change</span>
                </div>
                <div class="row row-block">
                    <input type="text" id="inputtext_${id}" class="form-control"/>
                </div>
            </div>    
          </div>`);

      // Set start value
      $("#inputtext_" + id).val($("#span_" + id).html());

      $("#inputtext_" + id).keyup(function () {
        $("#span_" + id).html($("#inputtext_" + id).val());
      });
    }

    this.createImportData = (id, full_id) => {
      let model = new viewModelInfographic();
      let mainTable = $('#table_' + id);
      let periodType;
      let classicTable;
      let selectDatasourceList = [];
      let selectDataList = [];
      let apiList = [];
      let dailyLables = [];
      let monthlyLables = [];
      let yearlyLables = [];

      $(".propertyMenu-2-paper").append(`                
          <div class="propertyMenu-2-block">
            <button type="button" id="edit_table_data_${id}" class="btn btn-default form-control button-width">Import data</button>    
          </div>`);

      //Edit click
      $("#edit_table_data_" + id).click(function () {
        
        selectDatasourceList = [];
        selectDataList = [];
        apiList = [];
        dailyLables = [];
        monthlyLables = [];
        yearlyLables = [];

        $("#model_edit_table_data_" + id).remove();

        $('body').append(model.EditTableMainModel(id, mainTable));
        $("#model_edit_table_data_" + id).modal('show');

        //First Set Up
        classicTable = cloneTable(mainTable[0].innerHTML, id);
        setButtonPeriod(id , mainTable.attr('period-type'), mainTable.attr('start-value'), mainTable.attr('end-value'));
        setValueClassicTable();
        setDefaultData(classicTable);

        //Period event
        $("#btn_daily_table_" + id).click(function () {
          periodType = "daily";
          selectDatasourceList = [];
          selectDataList = [];
          apiList = [];
          dailyLables = [];

          classicTable.find('td').html(``);

          let ctx  = $("#table_data_" + id);
          ctx.contents().remove();

          setDefaultData(classicTable);
        });

        $("#btn_monthly_table_" + id).click(function () {
          periodType = "monthly";
          selectDatasourceList = [];
          selectDataList = [];
          apiList = [];
          monthlyLables = [];

          classicTable.find('td').html(``);

          let ctx  = $("#table_data_" + id);
          ctx.contents().remove();

          setDefaultData(classicTable);
        });

        $("#btn_yearly_table_" + id).click(function () {
          periodType = "yearly";
          selectDatasourceList = [];
          selectDataList = [];
          apiList = [];
          yearlyLables = [];

          classicTable.find('td').html(``);

          let ctx  = $("#table_data_" + id);
          ctx.contents().remove();

          setDefaultData(classicTable);
        });

        $("#start_daily_table_" + id).change(function () {
          if($("#start_daily_table_" + id).val() != "" && $("#end_daily_table_" + id).val() != ""){
            $("#btn_daily_table_" + id).click();
          }
        });

        $("#end_daily_table_" + id).change(function () {
           if($("#start_daily_table_" + id).val() != "" && $("#end_daily_table_" + id).val() != ""){
            $("#btn_daily_table_" + id).click();
          }
        });

        $("#start_monthly_table_" + id).change(function () {
          if($("#start_monthly_table_" + id).val() != "" && $("#end_monthly_table_" + id).val() != ""){
            $("#btn_monthly_table_" + id).click();
          }
        });

        $("#end_monthly_table_" + id).change(function () {
          if($("#start_monthly_table_" + id).val() != "" && $("#end_monthly_table_" + id).val() != ""){
            $("#btn_monthly_table_" + id).click();
          }
        });

        $("#start_yearly_table_" + id).change(function () {
          if($("#start_yearly_table_" + id).val() != "" && $("#end_yearly_table_" + id).val() != ""){
            $("#btn_yearly_table_" + id).click();
          }
        });

        $("#end_yearly_table_" + id).change(function () {
          if($("#start_yearly_table_" + id).val() != "" && $("#end_yearly_table_" + id).val() != ""){
            $("#btn_yearly_table_" + id).click();
          }
        });

        //Label event
        $("#head_label_" + id).keyup(function () {
          $(classicTable.find('th')[0]).html($(this).val());
        });

        //Add button event
        $("#add_new_row_" + id).click(function () {

          let countCells = classicTable[0].rows[0].cells.length;
  
          for(let i = 0; i < classicTable[0].rows.length; i++)
          {
            let row = classicTable[0].rows[i];
            let cells;
  
            if(i == 0)
            {
              cells = row.cells[row.cells.length - 1];
              cells.insertAdjacentHTML("afterend", "<th>Column</th>");
            }
            else
            {
              cells = row.insertCell(countCells);
              cells.innerHTML = "###";
            }
          }  

          let ctx  = $("#table_data_" + id);
          ctx.contents().remove();

          selectDatasourceList.push(0);
          selectDataList.push("");

          setDefaultData(classicTable);
  
        });

        //Save event
        $("#save_table_data_" + id).click(function () {

          mainTable.attr("maiden-check", "false");
          mainTable.attr('period-type', periodType);
          mainTable.attr('start-value', $("#start_" + periodType + "_table_" + id).val());
          mainTable.attr('end-value', $("#end_" + periodType + "_table_" + id).val());

          if(periodType == "daily")
          {
            mainTable.attr('labels', dailyLables);
          }
          else if(periodType == "monthly")
          {
            mainTable.attr('labels', monthlyLables);
          }
          else if(periodType == "yearly")
          {
            mainTable.attr('labels', yearlyLables);
          }
          else
          {
            mainTable.attr('labels', dailyLables);
          }

          mainTable.attr('select-datasource-list', selectDatasourceList);
          mainTable.attr('select-keydata-list', selectDataList);

          $(".propertyMenu-2").html(``);

          mainTable.html(classicTable[0].innerHTML);

          var property = new ContentProperty();
          property.createTableProp(id, "#table_" + id, "table");

          $("#model_edit_table_data_" + id).modal('hide');
        });

        //Option event
        $("#model_edit_table_data_" + id).on("hidden.bs.modal", function () {

          if(mainTable.attr("maiden-check") == "wait")
          {
            mainTable.attr("maiden-check", "true");
          }
        });

      });

      //Function section

      //Table clone section
      function cloneTable(mainTableInner, id)
      {
        $("#preview_table_" + id).html(mainTableInner);

        let ctx = $("#preview_table_" + id);

        return ctx;
      }

      //Set up value section
      function setButtonPeriod(id, period_type, startValue, endValue)
      {
        if(period_type == "daily")
        {
          periodType = "daily";

          $("#btn_daily_table_" + id).addClass("active show");
          $("#daily_table_" + id).addClass("active show");

          $("#start_daily_table_" + id).val(startValue);
          $("#end_daily_table_" + id).val(endValue);

          if(mainTable.attr('labels') != null)
          {
            let labels = mainTable.attr('labels').split(',');
            for(let i = 0; i < labels.length; i++)
            {
              dailyLables.push(labels[i]);
            }
          }
        }
        else if(period_type == "monthly")
        {
          periodType = "monthly";

          $("#btn_monthly_table_" + id).addClass("active show");
          $("#monthly_table_" + id).addClass("active show");

          $("#start_monthly_table_" + id).val(startValue);
          $("#end_monthly_table_" + id).val(endValue);

          if(mainTable.attr('labels') != null)
          {
            let labels = mainTable.attr('labels').split(',');
            for(let i = 0; i < labels.length; i++)
            {
              monthlyLables.push(labels[i]);
            }
          }
        }
        else if(period_type == "yearly")
        {
          periodType = "yearly";

          $("#btn_yearly_table_" + id).addClass("active show");
          $("#yearly_table_" + id).addClass("active show");

          $("#start_yearly_table_" + id).val(startValue);
          $("#end_yearly_table_" + id).val(endValue);

          if(mainTable.attr('labels') != null)
          {
            let labels = mainTable.attr('labels').split(',');
            for(let i = 0; i < labels.length; i++)
            {
              yearlyLables.push(labels[i]);
            }
          }
        }
        else
        {
          periodType = "daily";
          $("#btn_daily_table_" + id).addClass("active show");
          $("#daily_table_" + id).addClass("active show");
        }
      }

      function setValueClassicTable()
      {
        if(mainTable.attr('select-datasource-list') != null)
        {
          let c = mainTable.attr('select-datasource-list').split(',').length;

          for(let k = 0; k < c; k++)
          {     
            if(mainTable.attr('select-datasource-list').split(',')[k] != null)
            {
              selectDatasourceList.push(mainTable.attr('select-datasource-list').split(',')[k]);
            }
            else
            {
              selectDatasourceList.push(0);
            }
  
            if(mainTable.attr('select-keydata-list').split(',')[k] != null)
            {
              selectDataList.push(mainTable.attr('select-keydata-list').split(',')[k]);
            }
            else
            {
              selectDataList.push("");
            }
          }
        }
      }

      //Setting value table section
      function setDefaultData(table)
      {
        for(var i = 0; i < table.find('th').length - 1; i++)
        {
          $("#table_data_" + id).append(model.DataClassicTableModel(id, i, table));

          $("#label_preview_table_" + id + "_" + i).keyup(labelPreviewChartUpdate(table, i));
          $("#delete_preview_table_" + id + "_" + i).click(deletePreviewChartUpdate(table, i));

          $("#select_datasource_list_table_" + id + "_" + i).change(datasourceValueUpdate(table, i));
          $("#id_keydata_list_table_" + id + "_" + i).change(datalistKeyValueUpdata(table, i));

          $("#delete_preview_table_" + id + "_0").remove();
        }

        $.ajax({
          url: END_POINT + 'infographic/getServiceByTypeUser',
          method: 'GET',
          data: {
            type_user: type_user,
          },
          success: (res, textStatus, xhr) => {
            checkAuthRes(xhr);
            listInfoDatasource = res.data;
            console.log(listInfoDatasource);
            let index = 0;

            listInfoDatasource.iotservice.map((data) => {
              $("optgroup[name='opt_iot_table']").append(`<option value="iot_${data.iotservice_id}_${data.company_id}" keydw="IoT.Input.nut_test2.11">${data.iot_name}</option>`);
              index++;
            });

            listInfoDatasource.webservice.map((data) => {
              $("optgroup[name='opt_web_table']").append(`<option value="web_${data.webservice_id}_${data.company_id}" keydw="IoT.Input.nut_test2.11">${data.service_name}</option>`);
              index++;
            });

            for(let j = 0; j < selectDatasourceList.length; j++)
            {
              $("#select_datasource_list_table_" + id + "_" + j).val(selectDatasourceList[j]);
              $("#select_datasource_list_table_" + id + "_" + j).change();

              $("#id_keydata_list_table_" + id + "_" + j).val(selectDataList[j]);
              $("#id_keydata_list_table_" + id + "_" + j).change();
            }

          },
          error: (res) => {
              console.log(res);
          }
        });
      }

      //Event updata chart data
      function datasourceValueUpdate(table, index)
      {
        return function()
        {
            let selectValue = $("#select_datasource_list_table_" + id + "_" + index).val();
            let tableDW = $("select#select_datasource_list_table_" + id + "_" + index + " option:selected").attr('keydw');

            if(selectValue != 0)
            {
              $("#datalist_keydata_list_table_" + id + "_" + index).html(`<option value=""></option>`);
              $("#id_keydata_list_table_" + id + "_" + index).val("");          
  
              //Demo test ISUS
              let check = checkDateValueTable(periodType, id);

              if(check == true)
              {
                let apiType = checkPeriod(periodType);
                let startDate = moment($("#start_" + periodType + "_table_" + id).val()).format('YYYY-MM-DD HH:mm:ss');
                let endDate = moment($("#end_" + periodType + "_table_" + id).val()).format('YYYY-MM-DD HH:mm:ss');

                $.ajax({
                  url: API_DW + 'iotService/getInputAggregationForWeb',
                  async:false,
                  method: 'POST',
                  data: {
                    type: apiType,
                    nameDW: tableDW,
                    end_date: endDate,
                    start_date: startDate
                  },
                  success: (res, textStatus, xhr) => {
                    checkAuthRes(xhr);

                    console.log(res);

                    apiList[index] = res;

                    let keyValueList = getFlatObject(apiList[index][0]);

                    for(var key in keyValueList)
                    {
                      if(key != "_id" && key != "DayOfWeek" && key != "real_date" && key != "create_date")
                      {
                        $("#datalist_keydata_list_table_" + id + "_" + index).append(`<option value="${key}"></option>`);
                      }
                    }

                    $("#id_keydata_list_table_" + id + "_" + index).val("");

                    if(mainTable.attr("maiden-check") == "true")
                    {
                      dailyLables = [];

                      table.find('td').html(``);

                      mainTable.attr("maiden-check", "wait");
                    }

                    let dateString = moment(apiList[index][0]["real_date"]).format('YYYY-MM-DD').toString();

                    for(let i = 1; i < table[0].rows.length; i++)
                    {
                      $(table[0].rows[i].cells[0]).html(dateString); 
                    }

                    if(table[0].rows[2] != null)
                    {
                      table[0].rows[2].remove();
                    }

                    
                    // let check = 0;
                    // let dateString;
                    // let dailyLength = dailyLables.length;

                    // for(let i = 0; i < apiList[index].length; i++)
                    // {
                    //   dateString = moment(apiList[index][i]["real_date"]).format('YYYY-MM-DD').toString();

                    //   for(let j = 0; j < table[0].rows.length; j++)
                    //   {
                    //     if(dateString == table[0].rows[j].cells[0].textContent)
                    //     {
                    //       check = 1;
                    //       break;
                    //     }
                    //   }

                    //   if(check != 1)
                    //   {
                    //     dailyLables.push(dateString);
                    //   }

                    //   check = 0;
                    // }      
                    
                    // for(let i = 0; i < dailyLables.length; i++)
                    // {
                    //   if(table[0].rows[i + 1] != null)
                    //   {
                    //     $(table[0].rows[i + 1].cells[0]).html(dailyLables[i]); 
                    //   }
                    //   else
                    //   {
                    //     let tableHtml = document.getElementById("preview_table_" + id);
                    //     let row = tableHtml.insertRow(table[0].rows.length);  

                    //     let cells = row.insertCell(0);
                    //     cells.innerHTML = dailyLables[i];    
                        
                    //     for(let i = 0; i < table[0].rows[0].cells.length - 1; i++)
                    //     {
                    //       let cells = row.insertCell(i + 1);
                    //       cells.innerHTML = "###";
                    //     }   
                    //   }
                    // }        
                  },
                  error: (res) => {
                    console.log(res);
                  }
                });
              }
            }
            else
            {
              $("#datalist_keydata_list_table_" + id + "_" + index).html(`<option value=""></option>`);
              $("#id_keydata_list_table_" + id + "_" + index).val("");
            }
  
            selectDatasourceList[index] = selectValue;
        };
      }

      function datalistKeyValueUpdata(table, index)
      {
        return function()
        {
            let selectKeyValue = $("#id_keydata_list_table_" + id + "_" + index).val();

            if(selectKeyValue != "" && apiList[index] != null)
            {
              let checkInput = false;
              let keyValueList = getFlatObject(apiList[index][0]);

              for(var key in keyValueList)
              {
                if(key == selectKeyValue)
                {
                  checkInput = true;
                  break;
                }
              }

              if(checkInput == true)
              {
                for(let i = 0; i < apiList[index].length; i++)
                {
                  for(let j = 0; j < table[0].rows.length - 1; j++)
                  {
                    let dateApi = moment(apiList[index][i]["real_date"]).format('YYYY-MM-DD').toString();

                    if(table[0].rows[j + 1].cells[0].textContent == dateApi)
                    {         
                      $(table[0].rows[j + 1].cells[index + 1]).html(objectPath.get(apiList[index][i], selectKeyValue));
                      break;
                    }
                  }
                }
              }
            
              selectDataList[index] = selectKeyValue;
            }
        };
      }

      function labelPreviewChartUpdate(table, index)
      {
        return function()
        {
          $(table.find('th')[index + 1]).html($("#label_preview_table_" + id + "_" + index).val());
        };
      }

      function deletePreviewChartUpdate(table, index)
      {
        return function()
        {

            for(var i = 0; i < classicTable[0].rows.length; i++)
            {
              var row = classicTable[0].rows[i];
              row.deleteCell(index + 1);      
            }  

            let ctx  = $("#table_data_" + id);
            ctx.contents().remove();

            selectDatasourceList.splice(index, 1);
            selectDataList.splice(index, 1);

            setDefaultData(table);     
        };
      }      
    }

    this.createScale = (id, full_id, type) => {
      $(".propertyMenu-2-paper").append(`  
          <div class="propertyMenu-2-block">
            <div class="container">
                <div class="row row-block">
                    <div class="col-6">
                        <span>Width (px)</span>
                    </div>
                    <div class="col-6">
                        <span>Height (px)</span>
                    </div>
                </div>
                <div class="row row-block">
                    <div class="col-6">
                        <input type="text" id="width_${id}" class="form-control" />
                    </div>
                    <div class="col-6">
                        <input type="text" id="height_${id}" class="form-control" />
                    </div>
                </div>
            </div>    
          </div>`);

      // Set start value
      $("#width_" + id).val(Math.round($(full_id).width()));
      $("#height_" + id).val(Math.round($(full_id).height()));

      $("#width_" + id).unbind().change(function () {
        $(full_id).css('width', $("#width_" + id).val());
        $(full_id).css('height', $("#height_" + id).val());

        if(type == "map")
        {
          $("#map_" + id).css('width', $("#width_" + id).val() - 100);
          $("#map_" + id).css('height', $("#height_" + id).val() - 100);
        }
      });

      $("#height_" + id).unbind().change(function () {
        $(full_id).css('width', $("#width_" + id).val());
        $(full_id).css('height', $("#height_" + id).val());

        if(type == "map")
        {
          $("#map_" + id).css('width', $("#width_" + id).val() - 100);
          $("#map_" + id).css('height', $("#height_" + id).val() - 100);
        }
      });
    }

    this.createAddColumnAndRow = (id, full_id) => {
      $(".propertyMenu-2-paper").append(`    
          <div class="propertyMenu-2-block">
            <div class="container">
                <div class="row row-block">
                    <span>New column name</span>
                </div>
                <div class="row row-block">
                    <div class="col-7">
                        <input type="text" id="column_name_${id}" class="form-control"/>
                    </div>
                    <div class="col-2">
                        <button type="button" id="add_column_${id}" class="btn btn-default" ><i class="fas fa-angle-right"></i></button>
                    </div>
                    <div class="col-1">
                        <button type="button" id="add_row_${id}" class="btn btn-default" ><i class="fas fa-angle-down"></i></button>
                    </div>
                </div>
                <div class="row-block">
                    <button type="button" id="delete_column_${id}" class="btn btn-default form-control button-width">Delete column</button>
                </div>
                <div class="row-block">
                    <button type="button" id="delete_row_${id}" class="btn btn-default form-control button-width">Delete row</button>
                </div>
            </div>    
          </div>`);

      $("#add_column_" + id).unbind().click(function () {
        var tableObject = $(full_id);
        var countCells = tableObject[0].rows[0].cells.length;

        for(var i = 0; i < tableObject[0].rows.length; i++)
        {
          var row = tableObject[0].rows[i];
          var cells;

          if(i == 0)
          {
            cells = row.cells[row.cells.length - 1];
            cells.insertAdjacentHTML("afterend", "<th>" + $("#column_name_" + id).val() + "</th>");
          }
          else
          {
            cells = row.insertCell(countCells);
            cells.innerHTML = "Data";
          }
        }  

        editTable();
      });

      $("#add_row_" + id).unbind().click(function () {
        var tableObject = $(full_id);
        var tableHtml = document.getElementById("table_" + id);
        var row = tableHtml.insertRow(tableObject[0].rows.length);

        for(var i = 0; i < tableObject[0].rows[0].cells.length; i++)
        {
          var cells = row.insertCell(i);
          cells.innerHTML = "Data";
        }      

        editTable();
      });

      $("#delete_column_" + id).unbind().click(function () {
        var tableObject = $(full_id);
        var countCells = tableObject[0].rows[0].cells.length;

        for(var i = 0; i < tableObject[0].rows.length; i++)
        {
          var row = tableObject[0].rows[i];
          row.deleteCell(countCells - 1);      
        }  
      });

      $("#delete_row_" + id).unbind().click(function () {
        var tableObject = $(full_id);
        var tableHtml = document.getElementById("table_" + id);
        tableHtml.deleteRow(tableObject[0].rows.length - 1);    
      });
      
      function editTable(){
        const editor = new SimpleTableCellEditor("table_" + id);
        editor.SetEditable("td",{
          keys : {
          validation: [13],
          cancellation: [27]
          }
        });

        editor.SetEditable("th",{
          keys : {
          validation: [13],
          cancellation: [27]
          }
        });
      }
    }

    this.createThemesTable = (id, full_id) => {
      $(".propertyMenu-2-paper").append(`  
          <div class="propertyMenu-2-block">
            <div class="container">
                <div class="row row-block">
                    <span>Themes</span>
                </div>
                <div class="row row-block">
                    <select type="text" id="themes_table_${id}" class="form-control">
                      <option value="1">Default</option>
                      <option value="2">Striped</option>
                      <option value="3">Bordered</option>
                    </select>
                </div>
            </div>    
          </div>`);

      var arrayClass = ["table-striped","table-bordered"];

      // Set start value
      document.getElementById("themes_table_" + id).selectedIndex = ($(full_id).attr('table-class') || 1) - 1;

      $("#themes_table_" + id).unbind().change(function () {

        // Remove table class
        var classList = document.getElementById('table_' + id).className.split(/\s+/);

        for (var i = 0; i < classList.length; i++) 
        {
            if(arrayClass.includes(classList[i]))
            {
              $(full_id).removeClass(classList[i]);
            }
        }
  
        // Add new table class
        var classSelect = $("#themes_table_" + id).val();
        
        switch(classSelect)
        {
          case "1" :
            $(full_id).attr('table-class', '1');
            break;
          case "2" :
            $(full_id).addClass('table-striped');
            $(full_id).attr('table-class', '2');
            break;
          case "3" :
          $(full_id).addClass('table-bordered');
            $(full_id).attr('table-class', '3');
            break;
        }
      });
    }

    this.createColorAndFont = (id, full_id) => {
      $(".propertyMenu-2-paper").append(`    
          <div class="propertyMenu-2-block">
            <div class="container">
                <div class="row row-block">
                    <div class="col-6 text-align-left">
                        <span>Color</span>
                    </div>
                    <div class="col-6 text-align-left">
                        <span>Font</span>
                    </div>
                </div>
                <div class="row row-block">
                    <div class="col-6">
                        <input type="color" id="color_font_${id}" class="form-control">
                    </div>
                    <div class="col-6">
                        <select type="text" id="family_font_${id}" class="form-control">
                          <option value="1">Poppins</option>
                          <option value="2">Times New Roman</option>
                          <option value="3">Arial</option>
                          <option value="4">Arial Black</option>
                          <option value="5">Georgia</option>
                          <option value="6">Tahoma</option>
                          <option value="7">Lucida Console</option>
                          <option value="8">Courier New</option>
                        </select>
                    </div>
                </div>
            </div>    
          </div>`);

      // Set start value
      $("#color_font_" + id).val(rgbToHex($("#span_" + id).css('color')));
      document.getElementById("family_font_" + id).selectedIndex = ($(full_id).attr('font-value') || 1) - 1;

      $("#color_font_" + id).unbind().change(function () {
        $("#span_" + id).css('color', $(this).val());
      });

      $("#family_font_" + id).unbind().change(function () {
        var fontSelect = $("#family_font_" + id).val();
        
        switch(fontSelect)
        {
          case "1" :
            $(full_id).css('font-family', 'Poppins, Kanit, sans-serif');
            $(full_id).attr('font-value', '1');
            break;
          case "2" :
            $(full_id).css('font-family', 'Times New Roman, Times, serif');
            $(full_id).attr('font-value', '2');
            break;
          case "3" :
            $(full_id).css('font-family', 'Arial, Helvetica, sans-serif');
            $(full_id).attr('font-value', '3');
            break;
          case "4" :
            $(full_id).css('font-family', 'Arial Black, Gadget, sans-serif');
            $(full_id).attr('font-value', '4');
            break;
          case "5" :
            $(full_id).css('font-family', 'Georgia, serif');
            $(full_id).attr('font-value', '5');
            break;
          case "6" :
            $(full_id).css('font-family', 'Tahoma, Geneva, sans-serif');
            $(full_id).attr('font-value', '6');
            break;
          case "7" :
            $(full_id).css('font-family', 'Lucida Console, Monaco, monospace');
            $(full_id).attr('font-value', '7');
            break;
          case "8" :
            $(full_id).css('font-family', 'Courier New, Courier, monospace');
            $(full_id).attr('font-value', '8');
            break;
        }
      });

      // Convert rgb code to hex code
      function rgbToHex(color) {
        color = "" + color;
        if (!color || color.indexOf("rgb") < 0) {
          return;
        }

        if (color.charAt(0) == "#") {
          return color;
        }

        var nums = /(.*?)rgb\((\d+),\s*(\d+),\s*(\d+)\)/i.exec(color),
          r = parseInt(nums[2], 10).toString(16),
          g = parseInt(nums[3], 10).toString(16),
          b = parseInt(nums[4], 10).toString(16);

        return "#" + (
          (r.length == 1 ? "0" + r : r) +
          (g.length == 1 ? "0" + g : g) +
          (b.length == 1 ? "0" + b : b)
        );
      }
    }

    this.createColorAndDeleteForShape = (id, full_id, full_id_shape, type) => {
      $(".propertyMenu-2-paper").append(` 
      <div class="propertyMenu-2-block">
        <div class="container">
            <div class="row row-block">
                <span>Color</span>
            </div>
            <div class="row row-block">
                <input type="color" class="form-control" id="color_shape_${id}">
            </div>
        </div>    
      </div>`);
      
      if(type == "square" || type == "circle")
      {
        // Set start value
        console.log($(full_id_shape).css('background-color'));
        $("#color_shape_" + id).val(rgbToHex($(full_id_shape).css('background-color')));

        $("#color_shape_" + id).unbind().change(function () {
          $(full_id_shape).css('background-color', $(this).val());
        });
      }
      else if(type == "string")
      {
        // Set start value
        $("#color_shape_" + id).val(rgbToHex($(full_id_shape).css('border-right-color')));

        $("#color_shape_" + id).unbind().change(function () {
          $(full_id_shape).css('border-right-color', $(this).val());
        });
      }

      // Convert rgb code to hex code
      function rgbToHex(color) {
        color = "" + color;
        if (!color || color.indexOf("rgb") < 0) {
          return;
        }

        if (color.charAt(0) == "#") {
          return color;
        }

        var nums = /(.*?)rgb\((\d+),\s*(\d+),\s*(\d+)\)/i.exec(color),
          r = parseInt(nums[2], 10).toString(16),
          g = parseInt(nums[3], 10).toString(16),
          b = parseInt(nums[4], 10).toString(16);

        return "#" + (
          (r.length == 1 ? "0" + r : r) +
          (g.length == 1 ? "0" + g : g) +
          (b.length == 1 ? "0" + b : b)
        );
      }
    }

    this.createStringStyle = (id, full_id, full_id_shape) => {
      $(".propertyMenu-2-paper").append(`          
          <div class="propertyMenu-2-block">
            <div class="container">
                <div class="row row-block">
                    <div class="col-4">
                        <button type="button" id="solid_style_${id}" class="btn btn-default" ><i class="fas fa-minus"></i></button>
                    </div>
                    <div class="col-4">
                        <button type="button" id="dotted_style_${id}" class="btn btn-default" ><i class="fas fa-ellipsis-h"></i></button>
                    </div>
                    <div class="col-4">
                        <button type="button" id="double_style_${id}" class="btn btn-default" ><i class="fas fa-equals"></i></button>
                    </div>
                </div>
            </div>    
          </div>`);
          
      $("#solid_style_" + id).unbind().click(function () {
        $(full_id_shape).css('border-right-style', "solid");
      });

      $("#dotted_style_" + id).unbind().click(function () {
        $(full_id_shape).css('border-right-style', "dotted");
      });

      $("#double_style_" + id).unbind().click(function () {
        $(full_id_shape).css('border-right-style', "double");
      });
    }

    this.createFontSize = (id, full_id) => {
      $(".propertyMenu-2-paper").append(` 
          <div class="propertyMenu-2-block">
            <div class="container">
                <div class="row row-block">
                    <span>Font size (pt)</span>
                </div>
                <div class="row row-block">
                    <div class="col-8" style="padding-left:0px;">
                        <input type="range" min="9" max="120" value="9" id="slider_font_widget_${id}" class="slider" />
                    </div>
                    <div class="col-4">
                        <input type="text" id="slider_font_input_widget_${id}" class="form-control" />
                    </div>
                </div>
            </div>    
          </div>`);

      // Set start value
      $("#slider_font_widget_" + id).val($(full_id).css('font-size').replace('px', ''));
      $("#slider_font_input_widget_" + id).val($(full_id).css('font-size').replace('px', ''));

      $("#slider_font_widget_" + id).unbind().change(function () {
        $("#slider_font_input_widget_" + id).val($(this).val());
        $(full_id).css('font-size', $(this).val() + "px");
      });

      $("#slider_font_input_widget_" + id).unbind().change(function () {
        if ($(this).val() < 9 || $(this).val() > 120) {
          alert("test : 9 - 120");
        }
        else {
          $("#slider_font_widget_" + id).val($(this).val());
          $(full_id).css('font-size', $(this).val() + "px");
        }
      });
    }

    this.createRotation = (id, full_id) => {
      $(".propertyMenu-2-paper").append(` 
          <div class="propertyMenu-2-block">
            <div class="container">
                <div class="row row-block">
                    <span>Rotation</span>
                </div>
                <div class="row row-block">
                    <div class="col-8" style="padding-left:0px;">
                        <input type="range" min="0" max="360" value="0" id="slider_rotation_widget_${id}" class="slider" />
                    </div>
                    <div class="col-4">
                        <input type="text" id="slider_rotation_input_widget_${id}" class="form-control" />
                    </div>
                </div>
            </div>    
          </div>`);

      var x = $(full_id).attr("data-x");
      var y = $(full_id).attr("data-y");
      var z = ($(full_id).attr("data-z") || 0);

      // Set start value
      $("#slider_rotation_widget_" + id).val(z);
      $("#slider_rotation_input_widget_" + id).val(z);

      $("#slider_rotation_widget_" + id).unbind().change(function () {
        var rotationValue = $(this).val();
        $("#slider_rotation_input_widget_" + id).val(rotationValue);
        $(full_id).attr('data-z', rotationValue);
        $(full_id).css('transform', 'translate(' + x + 'px, ' + y + 'px) rotate(' + rotationValue + 'deg)')
      });

      $("#slider_rotation_input_widget_" + id).unbind().change(function () {
        if ($(this).val() < 0 || $(this).val() > 360) {
          alert("test : 0 - 360");
        }
        else {
          var rotationValue = $(this).val();
          $("#slider_rotation_widget_" + id).val(rotationValue);
          $(full_id).attr('data-z', rotationValue);
          $(full_id).css('transform', 'translate(' + x + 'px, ' + y + 'px) rotate(' + rotationValue + 'deg)')
        }
      });
    }

    this.createTransparency = (id, full_id) => {
      $(".propertyMenu-2-paper").append(`    
          <div class="propertyMenu-2-block">
            <div class="container">
                <div class="row row-block">
                    <span>Transparency (%)</span>
                </div>
                <div class="row row-block">
                    <div class="col-8" style="padding-left:0px;">
                        <input type="range" min="0" max="100" value="1" id="slider_tran_widget_${id}" class="slider" />
                    </div>
                    <div class="col-4">
                        <input type="text" id="slider_tran_input_widget_${id}" class="form-control" />
                    </div>
                </div>
            </div>    
          </div>`);
          
      // Set start value
      $("#slider_tran_widget_" + id).val(100 - ($(full_id).css('opacity') * 100));
      $("#slider_tran_input_widget_" + id).val(100 - ($(full_id).css('opacity') * 100));

      $("#slider_tran_widget_" + id).unbind().change(function () {
        var opacityValue = (100 - $(this).val()) / 100;
        $("#slider_tran_input_widget_" + id).val($(this).val());
        $(full_id).css('opacity', opacityValue);
      });

      $("#slider_tran_input_widget_" + id).unbind().change(function () {
        if ($(this).val() < 0 || $(this).val() > 100) {
          alert("test : 0 - 100");
        }
        else {
          var opacityValue = (100 - $(this).val()) / 100;
          $("#slider_tran_widget_" + id).val($(this).val());
          $(full_id).css('opacity', opacityValue);
        }
      });
    }

    this.createBorderRadius = (id, full_id, full_id_shape) => {
      $(".propertyMenu-2-paper").append(` 
          <div class="propertyMenu-2-block">
            <div class="container">
                <div class="row row-block">
                    <span>Border radius (%)</span>
                </div>
                <div class="row row-block">
                    <div class="col-8" style="padding-left:0px;">
                        <input type="range" min="0" max="50" value="0" id="slider_radius_widget_${id}" class="slider" />
                    </div>
                    <div class="col-4">
                        <input type="text" id="slider_radius_input_widget_${id}" class="form-control" />
                    </div>
                </div>
            </div>    
          </div>`);
          
      // Set start value
      $("#slider_radius_widget_" + id).val($(full_id_shape).css('border-radius').replace('%', ''));
      $("#slider_radius_input_widget_" + id).val($(full_id_shape).css('border-radius').replace('%', ''));

      $("#slider_radius_widget_" + id).unbind().change(function () {
        var radiusValue = $(this).val();
        $("#slider_radius_input_widget_" + id).val($(this).val());
        $(full_id_shape).css('border-radius', radiusValue + "%");
      });

      $("#slider_radius_input_widget_" + id).unbind().change(function () {
        if ($(this).val() < 0 || $(this).val() > 50) {
          alert("test : 0 - 50");
        }
        else {
          var radiusValue = $(this).val();
          $("#slider_radius_widget_" + id).val($(this).val());
          $(full_id_shape).css('border-radius', radiusValue + "%");
        }
      });
    }

    this.createBorderWidth = (id, full_id, full_id_shape) => {
      $(".propertyMenu-2-paper").append(` 
          <div class="propertyMenu-2-block">
            <div class="container">
                <div class="row row-block">
                    <span>Border width (px)</span>
                </div>
                <div class="row row-block">
                    <div class="col-8" style="padding-left:0px;">
                        <input type="range" min="5" max="20" value="0" id="slider_width_widget_${id}" class="slider" />
                    </div>
                    <div class="col-4">
                        <input type="text" id="slider_width_input_widget_${id}" class="form-control" />
                    </div>
                </div>
            </div>    
          </div>`);
          
      // Set start value
      $("#slider_width_widget_" + id).val($(full_id_shape).css('border-right-width').replace('px', ''));
      $("#slider_width_input_widget_" + id).val($(full_id_shape).css('border-right-width').replace('px', ''));

      $("#slider_width_widget_" + id).unbind().change(function () {
        var widthValue = $(this).val();
        $("#slider_width_input_widget_" + id).val($(this).val());
        $(full_id_shape).css('border-right-width', widthValue + "px");
      });

      $("#slider_width_input_widget_" + id).unbind().change(function () {
        if ($(this).val() < 5 || $(this).val() > 20) {
          alert("test : 0 - 50");
        }
        else {
          var widthValue = $(this).val();
          $("#slider_width_widget_" + id).val($(this).val());
          $(full_id_shape).css('border-right-width', widthValue + "px");
        }
      });
    }

    this.createChartDetail = (id, full_id, myChart) => {
      $(".propertyMenu-2-paper").append(`  
          <div class="propertyMenu-2-block">
            <div class="container">
                <div class="row row-block">
                    <span>Chart properties</span>
                </div>
                <div id="color_and_text_${id}">
                </div>
            </div>    
          </div>`);

        for(var i = 0; i < myChart.data.datasets.length; i++)
        {
          $("#color_and_text_" + id).append(`   
              <div class="row row-block">
                <div class="col-4">
                    <input type="color" id="color_chart_${id}_${i}" class="form-control" value="${myChart.data.datasets[i].borderColor}">
                </div>
                <div class="col-8">
                    <input type="text" id="label_chart_${id}_${i}" class="form-control" value="${myChart.data.datasets[i].label}" />
                </div>
              </div>`);

            $("#color_chart_" + id + "_" + i).change(colorChartUpdate(myChart, i));
            $("#label_chart_" + id + "_" + i).keyup(labelChartUpdate(myChart, i));
        }

        function colorChartUpdate(myChart, index)
        {
          return function()
          {
            myChart.data.datasets[index].borderColor =  $("#color_chart_" + id + "_" + index).val();
            myChart.update();

            var ctx = $('#canvas_' + id);
            ctx.data("graph", myChart);
          };
        }

        function labelChartUpdate(myChart, index)
        {
          return function()
          {
            myChart.data.datasets[index].label =  $("#label_chart_" + id + "_" + index).val();
            myChart.update();

            var ctx = $('#canvas_' + id);
            ctx.data("graph", myChart);
          };
        }
    }

    this.createMapEvent = (mapObject, full_id) => {
      mapObject.on('mousemove', disableDraggable);
      mapObject.on('mouseout', enableDraggable);

      function disableDraggable(){
        interact(full_id).draggable(false);
        return;
      }

      function enableDraggable(){
        interact(full_id).draggable(true);
        return;
      }
    }
  } // Constructor
} // Property class

class ContentProperty extends Property {
  constructor() {
    /* Call function property */
    /* Select property for each widget type */
    super();
    this.createGraphProp = (id, myChart, full_id, type) => {
      this.createContext(id, full_id, type, myChart, null);
      this.createEditdata(id, myChart, full_id, type);
      this.createScale(id, full_id, type);
      this.createRotation(id, full_id);
      this.createTransparency(id, full_id);
      // this.createChartDetail(id, full_id, myChart);
    }

    this.createMapProp = (id, full_id, type, mapObject) => {
      this.createContext(id, full_id, type, null, null);
      this.createScale(id, full_id, type);
      this.createRotation(id, full_id);
      this.createTransparency(id, full_id);
      this.createMapEvent(mapObject, full_id);
    }

    this.createTextProp = (id, full_id, type) => {
      this.createContext(id, full_id, type, null, null);
      this.createTextchange(id, full_id);
      this.createScale(id, full_id, type);
      this.createRotation(id, full_id);
      this.createTransparency(id, full_id);
      this.createColorAndFont(id, full_id);
      this.createFontSize(id, full_id);
    }

    this.createTableProp = (id, full_id, type) => {
      this.createContext(id, full_id, type, null, null);
      this.createImportData(id, full_id);
      this.createScale(id, full_id, type);
      this.createAddColumnAndRow(id, full_id);
      this.createThemesTable(id, full_id);
      this.createRotation(id, full_id);
      this.createTransparency(id, full_id);
    }

    this.createImageProp = (id, full_id, full_id_image, type, pathImage) =>{
      this.createContext(id, full_id, type, null, pathImage);
      this.createCropImage(id, full_id, full_id_image);
      this.createScale(id, full_id, type);
      this.createRotation(id, full_id);
      this.createTransparency(id, full_id);
      this.createBorderRadius(id, full_id, full_id_image);
    }

    this.createShapeProp = (id, full_id, full_id_shape, type) =>{
      this.createContext(id, full_id, type, null, null);
      this.createColorAndDeleteForShape(id, full_id, full_id_shape, type);

      if(type == "string")
      {
        this.createStringStyle(id, full_id, full_id_shape);
      }

      this.createScale(id, full_id, type);
      this.createRotation(id, full_id);
      this.createTransparency(id, full_id);

      if(type == "string")
      {
        this.createBorderWidth(id, full_id, full_id_shape);
      }
      else
      {
        this.createBorderRadius(id, full_id, full_id_shape);   
      }
    }
  } // Constructor
} // ContentProperty class

/* Set initial value */
$(document).ready(function () {
  let workspace = new Workspace();
  var object    = null;
  let arrayService = [];

  /* Setting element */
  workspace.initialAndRun({});
  
  $.ajax({
    url: END_POINT + 'infographic/getServiceByTypeUser',
    method: 'GET',
    async:false,
    data: {
      type_user: type_user,
    },
    success: (res, textStatus, xhr) => {
      checkAuthRes(xhr);
      let listService = res.data;

      listService.iotservice.map((data) => {
        arrayService.push("iot_" + data.iotservice_id + "_" + data.company_id);
      });

      listService.webservice.map((data) => {
        arrayService.push("web_" + data.webservice_id + "_" + data.company_id);
      });

    },
    error: (res) => {
        console.log(res);
    }
  });

  /* Get saved data */
  $.ajax({
    url: END_POINT + 'infographic/getInfoByInfoID',
    method: 'GET',
    async:false,
    data: {
        info_id: infoID
    },
    success: (res, textStatus, xhr) => {
      checkAuthRes(xhr);
      if(res.data.info_data != null)
      {
        object = CircularJSON.parse(res.data.info_data);
        workspace.loadWidgetData(object, arrayService);
        console.log(object);
      }
    },
    error: (res) => {
      console.log("error");
    }
  }); //Ajax
}); //Document ready

/* Globle function */
function arrayRemove(arr, value) {
  return arr.filter(function (ele) {
    return ele.id != value;
  });
}

let deepCopy = (data) => {
  return data.map((item) => {
      return Object.assign({}, item);
  });
};

function toDataUrl(url, callback) {
  var xhr = new XMLHttpRequest();
  xhr.onload = function() {
      var reader = new FileReader();
      reader.onloadend = function() {
          callback(reader.result);
      }
      reader.readAsDataURL(xhr.response);
  };
  xhr.open('GET', url);
  xhr.responseType = 'blob';
  xhr.send();
}

function checkTypeApi(type){
  let check;
  if(type = "daily")
  {
    check = "Day";
  }
  else if(type = "monthly")
  {
    check = "Month";
  }
  else if(type = "yearly")
  {
    check = "Year";
  }
  return check;
}

function getLengthDate(timeseries)
{
  let today = new Date();
  let startDate;
  let endDate;

  if(timeseries == "today")
  {
    endDate = moment(today).endOf('day').format('YYYY-MM-DD HH:mm:ss');
    startDate = moment(today).startOf('day').format('YYYY-MM-DD HH:mm:ss');
  }
  else if(timeseries == "yesterday")
  {
    let yesterday = moment(today).subtract(1, 'days').format('YYYY-MM-DD');
    endDate = moment(yesterday).endOf('day').format('YYYY-MM-DD HH:mm:ss');
    startDate = moment(yesterday).startOf('day').format('YYYY-MM-DD HH:mm:ss');
  }
  else if(timeseries == "current_week")
  {
    startDate = moment(today).startOf('week').format('YYYY-MM-DD HH:mm:ss');
    endDate = moment(today).endOf('week').format('YYYY-MM-DD HH:mm:ss');
  }
  else if(timeseries == "1_week_later")
  {
    startDate = moment(today).subtract(7, 'days').format('YYYY-MM-DD HH:mm:ss');
    endDate = moment(today).format('YYYY-MM-DD HH:mm:ss');
  }
  else if(timeseries == "2_week_later")
  {
    startDate = moment(today).subtract(14, 'days').format('YYYY-MM-DD HH:mm:ss');
    endDate = moment(today).format('YYYY-MM-DD HH:mm:ss');
  }
  else if(timeseries == "4_week_later")
  {
    startDate = moment(today).subtract(28, 'days').format('YYYY-MM-DD HH:mm:ss');
    endDate = moment(today).format('YYYY-MM-DD HH:mm:ss');
  }
  else if(timeseries == "current_month")
  {
    startDate = moment(today).startOf('month').format('YYYY-MM-DD HH:mm:ss');
    endDate = moment(today).endOf('month').format('YYYY-MM-DD HH:mm:ss');
  }
  else if(timeseries == "last_month")
  {
    startDate = moment(today).subtract(1, 'months').startOf('month').format('YYYY-MM-DD  HH:mm:ss');
    endDate = moment(today).subtract(1, 'months').endOf('month').format('YYYY-MM-DD  HH:mm:ss');
  }
  else if(timeseries == "3_month_later")
  {
    startDate = moment(today).subtract(90, 'days').format('YYYY-MM-DD');
    endDate = moment(today).format('YYYY-MM-DD HH:mm:ss');
  }
  else if(timeseries == "6_month_later")
  {
    startDate = moment(today).subtract(180, 'days').format('YYYY-MM-DD');
    endDate = moment(today).format('YYYY-MM-DD HH:mm:ss');
  }
  else if(timeseries == "12_month_later")
  {
    startDate = moment(today).subtract(360, 'days').format('YYYY-MM-DD');
    endDate = moment(today).format('YYYY-MM-DD HH:mm:ss');
  } 

  return [startDate, endDate];
}

function checkDateValueTable(period_type, id)
{
  let check = false;

  if(period_type == "daily")
  {
    if($("#start_daily_table_" + id).val() != "" && $("#end_daily_table_" + id).val() != "")
    {
      check = true;
    }
  }
  else if(period_type == "monthly")
  {
    if($("#start_monthly_table_" + id).val() != "" && $("#end_monthly_table_" + id).val() != "")
    {
      check = true;
    }
  }
  else if(period_type == "yearly")
  {
    if($("#start_yearly_table_" + id).val() != "" && $("#end_yearly_table_" + id).val() != "")
    {
      check = true;
    }
  }

  return check;
}

function checkPeriod(period_type)
{
  let check;

  if(period_type == "daily")
  {
    check = "Day";
  }
  else if(period_type == "monthly")
  {
    check = "Month";
  }
  else if(period_type == "yearly")
  {
    check = "Year";
  }

  return check;
}



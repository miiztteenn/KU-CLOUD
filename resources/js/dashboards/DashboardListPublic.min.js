import { get } from "http";

let state = {
    total_dashboard : 0,
    dashboardList : null,
    startOld : 0,
    start : 0,
    length : 5,
    search : "",
};

let api = {
    getDashboards : 'dashboards/public'
};

class DashboardList{
    constructor(){
        let layoutList = $("#layoutList").html();

        let bindElement = () => {
            $(window).scroll(function(){
                if($(window).scrollTop() === $(document).height() - $(window).height()){
                    state.startOld =   state.start;
                    state.start =  state.start + state.length;
                    getDashboards();
                }
            });

            $("#search_dashboard_input").keyup(function(){
                state.search = $(this).val();
                state.start = 0;
                state.startOld = 0;
                getDashboards(true);
            });
        };

        let createList = (removeList = false) => {
            if(removeList){
                $("#dashboardList > div").empty();
            };

            if(state.dashboardList.length > 0){
                let html =  "";
                state.dashboardList.map((_data,index) => {
                    html = layoutList.replace("[[name]]",_data.name);
                    html = html.replace("[[des]]",_data.description);
                    html = html.replace("[[key]]",_data.dashboard_id);
                    $("#dashboardList > div").append(html);
                });

                $(".link").unbind().click(function(){
                    window.location.href = END_POINT_WED + "/" + "Dashboards/Public/" + $(this).attr("key");
                });
            }
            else{
                state.start =  state.startOld;
            }
        }

        let showLoading = (isShow) => {
            if(isShow){
                $("#loading").show();
            }
            else{
                $("#loading").hide();
            }
        }

        let getDashboards = (removeList = false) => {
            showLoading(true);
            $.ajax({
                url : END_POINT+api.getDashboards,
                data : {
                    start : state.start,
                    length : state.length,
                    search : state.search
                },
                success : (res) => {
                    state.dashboardList = res.data.dashboards;
                    if(removeList){
                        state.total_dashboard = res.data.dashboards.length
                        $("#total_dashboard").html("Total dashboard : "+ state.total_dashboard );
                    }
                    else{
                        let total_old = state.total_dashboard;
                        state.total_dashboard = res.data.dashboards.length
                        let total_new = total_old+state.total_dashboard 
                        $("#total_dashboard").html("Total dashboard : "+ total_new);
                    }
                    createList(removeList);
                    showLoading(false);
                },
                error : (res) => {
                    //console.log(res);
                }
            })
        }


        this.initAndRun = () => {
            bindElement();
            getDashboards();
        };
    }
}


$(document).ready(function(){
    let d = new DashboardList();
    d.initAndRun();
});